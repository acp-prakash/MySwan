<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MySwan – Pattern History</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f4f5f7;
            color: #222;
        }
        .app-container { width: 100%; margin: 0; padding: 0; }
        .card { width: 100%; margin: 0; border-radius: 0; padding: 20px; }
        #grid { width: 100%; }
        h1 { margin: 0 0 8px; font-size: 28px; }
        .ticker-badge { display: inline-block; background: #2563eb; color: white; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 20px; margin-left: 10px; }
        .sub-title { margin-bottom: 16px; color: #6b7280; font-size: 14px; }
        .toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 16px; }
        .toolbar button { padding: 8px 14px; border-radius: 999px; border: none; font-size: 14px; cursor: pointer; background: #2563eb; color: #fff; font-weight: 500; }
        .toolbar button.secondary { background: #e5e7eb; color: #111827; }
        .grid-info { margin-top: 8px; font-size: 13px; color: #6b7280; }
        .tabulator .tabulator-header .tabulator-col { background: #f9fafb; font-size: 11px; font-weight: 600; padding: 8px 4px; }
        .tabulator .tabulator-cell { font-size: 11px; padding: 6px 4px; }
        .trend-long { color: #10b981; font-weight: 600; }
        .trend-short { color: #ef4444; font-weight: 600; }
        .back-link { display: inline-block; margin-bottom: 16px; color: #2563eb; text-decoration: none; font-weight: 500; }
        .back-link:hover { text-decoration: underline; }
    </style>
    <script>
        // Minimal Luxon shim for Tabulator's datetime module (implements needed DateTime.FNs)
        (function(){
            if (window.luxon && window.luxon.DateTime) return;
            window.luxon = {
                DateTime: {
                    fromISO: function(s){
                        try{
                            var d = new Date(s);
                            var valid = !isNaN(d.getTime());
                            return {
                                isValid: valid,
                                toISO: function(){ return valid ? d.toISOString() : null; },
                                toISODate: function(){ return valid ? d.toISOString().slice(0,10) : null; },
                                toJSDate: function(){ return valid ? d : null; }
                            };
                        }catch(e){ return { isValid:false }; }
                    },
                    fromMillis: function(ms){
                        try{ var d=new Date(Number(ms)); var valid = !isNaN(d.getTime()); return { isValid:valid, toISO:function(){return d.toISOString()}, toISODate:function(){return d.toISOString().slice(0,10)}, toJSDate:function(){return d} }; }catch(e){return {isValid:false};}
                    },
                    fromSeconds: function(s){ return this.fromMillis(Number(s)*1000); }
                }
            };
        })();
    </script>
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="app-container">
    <div class="card">
        <a href="patterns.html" class="back-link">← Back to Patterns</a>
        <h1>Pattern History <span class="ticker-badge" id="tickerBadge">-</span></h1>
        <div class="sub-title">
            View <strong>historical pattern signals</strong> for this ticker. Track how patterns have evolved over time.
            <br>
            <a href="index.html" style="margin-right: 10px;">Dashboard</a>
            <a href="classic.html" style="margin-right: 10px;">Classic View</a>
            <a href="patterns.html" style="margin-right: 10px;">Patterns</a>
            <a href="settings.html" style="margin-right: 10px;">Settings</a>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button id="reloadBtn">Reload</button>
            <button id="clearFiltersBtn" class="secondary">Clear Filters</button>
            <button id="exportExcelBtn" class="secondary">Export Excel</button>
        </div>

        <!-- Grid container -->
        <div id="grid"></div>
        <div class="grid-info" id="gridInfo"></div>
    </div>
</div>

<script>
    const API_BASE = "http://jpmaxtricks.com:8070/api";
    let table;
    let currentTicker = "";

    const columns = [
        {title: "Date", field: "histDate", headerFilter: "input", width: 85, sorter: customDateSorter},
        {title: "Tick", field: "ticker", headerFilter: "input", headerFilterPlaceholder: "Filter...", width: 75},
        {title: "Pattern", field: "name", headerFilter: "input", headerFilterPlaceholder: "Filter...", width: 130},
        {title: "Trend", field: "trend", headerFilter: "input", headerFilterPlaceholder: "long", width: 65, formatter: function(cell) { const val = cell.getValue(); if (val === 'long') return '<span class="trend-long">LONG</span>'; if (val === 'short') return '<span class="trend-short">SHORT</span>'; return val; }},
        {title: "Chg", field: "change", headerFilter: "input", headerFilterPlaceholder: ">2", width: 65, formatter: function(cell){ const v = cell.getValue(); if (!v) return '-'; const formatted = v.toFixed(2); if (v > 0) return `<span style="color: #22c55e;">▲ ${formatted}</span>`; if (v < 0) return `<span style="color: #ef4444;">▼ ${formatted}</span>`; return formatted; }},
        {title: "High", field: "high", headerFilter: "input", headerFilterPlaceholder: "<200", width: 65, formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(2) : '-'; }},
        {title: "Low", field: "low", headerFilter: "input", headerFilterPlaceholder: ">50", width: 60, formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(2) : '-'; }},
        {title: "Entry", field: "entry", headerFilter: "input", headerFilterPlaceholder: ">100", width: 65},
        {title: "Price", field: "price", headerFilter: "input", headerFilterPlaceholder: ">100", width: 65, formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(2) : '-'; }},
        {title: "Min Target", field: "minPT", headerFilter: "input", headerFilterPlaceholder: ">100", width: 65},
        {title: "Max Target", field: "maxPT", headerFilter: "input", headerFilterPlaceholder: ">150", width: 60},
        {title: "Target Date", field: "targetDate", headerFilter: "input", headerFilterPlaceholder: "2025-12", width: 100},
        {title: "Stop", field: "stop", headerFilter: "input", headerFilterPlaceholder: "<100", width: 65},
        {title: "Dn↓", field: "downDays", headerFilter: "input", headerFilterPlaceholder: ">=3", width: 60, hozAlign: "center", formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #ef4444; font-weight: 600;">${val}</span>`; return val || '-'; }},
        {title: "UpHi", field: "upHigh", headerFilter: "input", headerFilterPlaceholder: ">100", width: 70, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #22c55e;">${val.toFixed(2)}</span>`; return '-'; }},
        {title: "piScore", field: "piScore", headerFilter: "input", width: 70},
        {title: "Rank", field: "Rank", headerFilter: "input", width: 70},
        {title: "safe", field: "safe", headerFilter: "input", width: 70},
        {title: "btMet", field: "bottomConditionsMet", headerFilter: "input", width: 70},
        {title: "btStr", field: "btStr", headerFilter: "input", width: 70},
        {title: "SS", field: "spikeScore", headerFilter: "input", width: 60},
        {title: "spike", field: "spikeType", headerFilter: "input", width: 70},
        {title: "PrimCat", field: "PrimCat", headerFilter: "input", width: 70},
        {title: "Cat", field: "Cat", headerFilter: "input", width: 70},
        {title: "Signal", field: "signal", headerFilter: "input", headerFilterPlaceholder: "BUY", width: 70, formatter: function(cell) { const val = cell.getValue(); if (val === 'BUY') return '<span style="color: #22c55e; font-weight: 600;">BUY</span>'; if (val === 'SELL') return '<span style="color: #ef4444; font-weight: 600;">SELL</span>'; return val || '-'; }},
        {title: "SigD", field: "SigD", headerFilter: "input", width: 70, formatter: function(cell) { const val = cell.getValue(); if (val === 'BUY') return `<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; if (val === 'SELL') return `<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; return val; }},
        {title: "Score", field: "overallScore", headerFilter: "input", headerFilterPlaceholder: ">70", width: 50, hozAlign: "center"},
        {title: "L#", field: "noOfLongPatterns", headerFilter: "input", headerFilterPlaceholder: ">0", width: 50, hozAlign: "center"},
        {title: "S#", field: "noOfShortPatterns", headerFilter: "input", headerFilterPlaceholder: ">0", width: 50, hozAlign: "center"},
        {title: "BTL", field: "btLongRating", headerFilter: "input", headerFilterPlaceholder: "Buy", width: 80},
        {title: "BTS", field: "btShortRating", headerFilter: "input", headerFilterPlaceholder: "Sell", width: 80},
        {title: "BTT", field: "btTrend", headerFilter: "input", headerFilterPlaceholder: "Up", width: 70}
    ];

    // Custom date sorter that uses plain JS Date parsing to avoid Luxon dependency
    function customDateSorter(a, b) {
        try {
            const sa = a == null ? '' : String(a);
            const sb = b == null ? '' : String(b);
            const ta = Date.parse(sa);
            const tb = Date.parse(sb);
            if (isNaN(ta) && isNaN(tb)) return 0;
            if (isNaN(ta)) return 1;
            if (isNaN(tb)) return -1;
            return ta - tb;
        } catch (e) {
            return 0;
        }
    }

    function createTable() {
        if (table) table.destroy();
        table = new Tabulator("#grid", {
            layout: "fitDataStretch",
            height: "calc(100vh - 280px)",
            pagination: true,
            paginationSize: 50,
            paginationSizeSelector: [25, 50, 100, 200, 500],
            columns: columns,
            initialSort: [ {column: "histDate", dir: "desc"} ]
        });
    }

    function getTickerFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('ticker');
    }

    async function loadData() {
        currentTicker = getTickerFromUrl();
        if (!currentTicker) { alert('No ticker specified in URL'); return; }

        document.getElementById('tickerBadge').textContent = currentTicker;
        createTable();

        try {
            // Load pattern history which already contains embedded `stock` snapshot
            const response = await fetch(`${API_BASE}/pattern/history/${encodeURIComponent(currentTicker)}`);
            const patternHistory = await response.json();

            // Map each pattern to include top-level stock fields (if present) so grid columns work directly
            const data = patternHistory.map(p => ({
                ...p,
                histDate: formatDateString(p.histDate),
                price: p.stock?.price,
                change: p.stock?.change,
                high: p.stock?.high,
                low: p.stock?.low,
                open: p.stock?.open,
                volume: p.stock?.volume,
                upDays: p.stock?.upDays,
                downDays: p.stock?.downDays,
                upHigh: p.stock?.upHigh,
                downLow: p.stock?.downLow,
                piScore: p.stock?.dailyRank?.pickScore,
                Rank: p.stock?.dailyRank?.finalRank,
                safe: p.stock?.dailyRank?.safetyRank,
                PrimCat: p.stock?.filterCategory?.primaryCategory,
                Cat: p.stock?.filterCategory?.category,
                signal: p.stock?.score?.signal,
                SigD: p.stock?.score?.signalDays,
                bottomConditionsMet: p.stock?.bottom?.conditionsMet,
                btStr: p.stock?.bottom?.strength,
                spikeScore: p.stock?.spike?.spikeScore,
                spikeType: p.stock?.spike?.spikeType,
                overallScore: p.stock?.score?.overallScore,
                noOfLongPatterns: p.noOfLongPatterns,
                noOfShortPatterns: p.noOfShortPatterns,
                btLongRating: p.stock?.rating?.btLongRating,
                btShortRating: p.stock?.rating?.btShortRating,
                btTrend: p.stock?.rating?.btTrend
            }));

            if (table) {
                table.setData(data);
                updateGridInfo(data.length);
            }

        } catch (err) {
            console.error('Error loading pattern history:', err);
            alert('Failed to load pattern history: ' + err.message);
        }
    }

    function updateGridInfo(count) {
        const info = document.getElementById('gridInfo');
        info.textContent = `Showing ${count} historical pattern${count !== 1 ? 's' : ''} for ${currentTicker}`;
    }

    function exportExcel() {
        if (!table) return;
        const data = table.getData();
        if (!data.length) return alert('No data to export');

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Pattern History');
        XLSX.writeFile(wb, `myswan-pattern-history-${currentTicker}-${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // Date formatting helper: use plain JS Date parsing and fallbacks
    function formatDateString(raw) {
        if (raw === null || raw === undefined) return '-';

        // If already a Date object
        if (raw instanceof Date) {
            if (isNaN(raw)) return '-';
            return raw.toISOString().slice(0, 10);
        }

        const s = String(raw).trim();
        if (!s) return '-';

        // If looks like YYYY-MM-DD or starts with it, just return first 10 chars
        const isoDateMatch = s.match(/^(\d{4}-\d{2}-\d{2})/);
        if (isoDateMatch) return isoDateMatch[1];

        // If it's a numeric timestamp (seconds or ms)
        if (/^\d+$/.test(s)) {
            try {
                // Try as milliseconds first, then seconds
                let t = Number(s);
                let d = new Date(t);
                if (isNaN(d.getTime()) || t < 1e11) { // likely seconds
                    d = new Date(t * 1000);
                }
                if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);
            } catch (e) { /* fallthrough */ }
        }

        // Try Date.parse for other string formats
        try {
            const parsed = Date.parse(s);
            if (!isNaN(parsed)) {
                const d = new Date(parsed);
                return d.toISOString().slice(0, 10);
            }
        } catch (e) { /* ignore */ }

        // Fallback: return first 10 chars if available, else the whole string
        return s.length >= 10 ? s.slice(0, 10) : s;
    }

    // Event Listeners
    document.getElementById('reloadBtn').addEventListener('click', loadData);
    document.getElementById('clearFiltersBtn').addEventListener('click', () => { if (table) table.clearHeaderFilter(); });
    document.getElementById('exportExcelBtn').addEventListener('click', exportExcel);

    // Initialize
    window.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
