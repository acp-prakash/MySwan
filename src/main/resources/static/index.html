<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySwan Dashboard - Trading Analytics</title>

    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --border-color: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success-color: #22c55e;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header - Ultra Compact */
        .header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 0.25rem 0.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        .logo h1 {
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-links a:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
        }

        .nav-links a.active {
            background: var(--primary-color);
            color: white;
        }

        /* Container - Full Width for Maximum Columns */
        .container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0.25rem 0.5rem;
        }

        /* Stats Cards - Ultra Compact */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .stat-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .stat-icon.blue { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--secondary-color); }
        .stat-icon.purple { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.65rem;
        }

        .stat-change {
            font-size: 0.65rem;
            margin-top: 0.15rem;
            padding: 0.1rem 0.25rem;
            border-radius: 3px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        /* Control Panel - Ultra Compact */
        .control-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .control-header h2 {
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .control-group label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .control-group select,
        .control-group input {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            transition: all 0.3s;
            min-width: 100px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Buttons - Ultra Compact */
        .btn {
            padding: 0.3rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
            border-color: var(--text-primary);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        /* Data Grid - Compact */
        .data-grid {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .grid-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .grid-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Enhanced text visibility */
        #dataTable {
            font-family: 'Segoe UI', 'Roboto', system-ui, sans-serif;
        }

        /* Make specific data more visible */
        .tabulator-cell[tabulator-field="ticker"] {
            font-weight: 700;
            font-size: 13px;
        }

        .tabulator-cell[tabulator-field="change"] {
            font-weight: 700;
            font-size: 13px;
        }

        .tabulator-cell[tabulator-field="price"] {
            font-weight: 700;
            font-size: 13px;
        }

        /* Signal badges - more visible */
        .tabulator-cell span[style*="BUY"],
        .tabulator-cell span[style*="SELL"] {
            padding: 4px 10px !important;
            font-size: 11px !important;
            font-weight: 700 !important;
            border-radius: 6px !important;
            letter-spacing: 0.5px;
        }

        /* Tabulator Dark Theme - Smaller Font, Wrapped Headers */
        .tabulator {
            background: #1a1f2e !important;
            border: 2px solid #3b4252;
            font-size: 9px;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        /* Force dark background for table body */
        .tabulator-tableholder {
            background: #1a1f2e !important;
        }

        .tabulator-table {
            background: #1a1f2e !important;
        }

        .tabulator-header {
            background: linear-gradient(180deg, #3b4860 0%, #2e3440 100%);
            border-bottom: 4px solid #81a1c1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .tabulator-col {
            background: rgba(129, 161, 193, 0.15);
            border-right: 2px solid #5e81ac;
            vertical-align: top;
        }

        .tabulator-col:hover {
            background: rgba(129, 161, 193, 0.25);
        }

        .tabulator-col-title {
            color: #ffd700 !important;
            font-weight: 700;
            padding: 6px 4px;
            font-size: 9px;
            letter-spacing: 0.2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
            white-space: normal !important;
            word-wrap: break-word !important;
            line-height: 1.2;
        }

        .tabulator-col-title-holder {
            color: #ffd700 !important;
        }

        /* Make header text super visible with bright yellow color and wrap text */
        .tabulator-header .tabulator-col .tabulator-col-content .tabulator-col-title {
            color: #ffd700 !important;
            background: rgba(30, 41, 59, 0.6);
            padding: 3px 4px;
            border-radius: 4px;
            font-size: 9px;
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }

        /* Force bright color on all header text elements */
        .tabulator-col-title,
        .tabulator-col-title *,
        .tabulator-header .tabulator-col-title-holder,
        .tabulator-header .tabulator-col-content {
            color: #ffd700 !important;
        }

        /* Sortable column hover */
        .tabulator-col.tabulator-sortable:hover {
            background: rgba(129, 161, 193, 0.2);
        }

        .tabulator-col.tabulator-sortable .tabulator-col-title {
            padding-right: 25px;
        }

        /* Sort arrows more visible */
        .tabulator-arrow {
            border-bottom: 6px solid #88c0d0;
            border-top: 6px solid #88c0d0;
        }

        .tabulator-header-filter input {
            background: #141821;
            border: 2px solid #5e81ac;
            color: #ffffff;
            padding: 3px 4px;
            font-size: 9px;
            font-weight: 600;
            border-radius: 4px;
        }

        .tabulator-header-filter input:focus {
            border-color: #88c0d0;
            outline: none;
            background: #1a1f2e;
            box-shadow: 0 0 8px rgba(136, 192, 208, 0.4);
        }

        .tabulator-header-filter input::placeholder {
            color: #8fbcbb;
            font-weight: 500;
        }

        .tabulator-row {
            background: #242933 !important;
            border-bottom: 1px solid #3b4252;
            min-height: 28px;
        }

        .tabulator-row:nth-child(even) {
            background: #2a303c !important;
        }

        .tabulator-row:nth-child(odd) {
            background: #242933 !important;
        }

        .tabulator-row:hover {
            background: #3d4758 !important;
        }

        .tabulator-row.tabulator-selected {
            background: #4c5a73 !important;
        }

        /* Force dark background during all interactions */
        .tabulator-row.tabulator-row-even {
            background: #2a303c !important;
        }

        .tabulator-row.tabulator-row-odd {
            background: #242933 !important;
        }

        /* Prevent white backgrounds during virtual DOM updates */
        .tabulator-row[role="row"] {
            background: #242933 !important;
        }

        .tabulator-row[role="row"]:nth-child(even) {
            background: #2a303c !important;
        }

        .tabulator-cell {
            color: #e5e9f0 !important;
            background: transparent !important;
            border-right: 1px solid #3b4252;
            padding: 6px 4px;
            line-height: 1.3;
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            font-size: 9px;
        }

        /* Prevent cell backgrounds from turning white */
        .tabulator-cell[tabulator-field] {
            background: transparent !important;
        }

        /* Enhanced link visibility */
        .tabulator-cell a {
            color: #81a1c1 !important;
            font-weight: 600;
            text-decoration: none;
        }

        .tabulator-cell a:hover {
            color: #88c0d0 !important;
            text-decoration: underline;
            text-shadow: 0 0 8px rgba(136, 192, 208, 0.5);
        }

        /* Number cells - better readability */
        .tabulator-cell[tabulator-field*="score"],
        .tabulator-cell[tabulator-field*="Score"],
        .tabulator-cell[tabulator-field*="price"],
        .tabulator-cell[tabulator-field*="Price"] {
            font-weight: 600;
            color: #d8dee9;
        }

        .tabulator-footer {
            background: #2e3440;
            border-top: 2px solid #4c566a;
            color: #d8dee9;
            padding: 10px;
        }

        .tabulator-page {
            background: rgba(94, 129, 172, 0.2);
            color: #88c0d0;
            border: 2px solid #5e81ac;
            margin: 0 4px;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 13px;
        }

        .tabulator-page:hover {
            background: rgba(94, 129, 172, 0.4);
            color: #8fbcbb;
        }

        .tabulator-page.active {
            background: #5e81ac;
            color: #eceff4;
            border-color: #81a1c1;
        }

        /* Scrollbar - much more visible */
        .tabulator::-webkit-scrollbar {
            height: 14px;
            width: 14px;
        }

        .tabulator::-webkit-scrollbar-track {
            background: #1a1f2e;
            border: 1px solid #3b4252;
        }

        .tabulator::-webkit-scrollbar-thumb {
            background: #4c566a;
            border-radius: 7px;
            border: 2px solid #1a1f2e;
        }

        .tabulator::-webkit-scrollbar-thumb:hover {
            background: #5e81ac;
        }

        .tabulator::-webkit-scrollbar-corner {
            background: #1a1f2e;
        }

        /* Make empty cells visible */
        .tabulator-cell:empty:after {
            content: '-';
            color: #6c7a8e;
            font-weight: 400;
        }

        /* Tooltip Styling - Dark with Bright Gold Text */
        .tabulator-tooltip {
            background: #1a1f2e !important;
            border: 2px solid #5e81ac !important;
            color: #ffd700 !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            padding: 8px 12px !important;
            border-radius: 6px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
            max-width: 400px !important;
            word-wrap: break-word !important;
        }

        /* Info Panel - Ultra Compact */
        .info-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background: rgba(37, 99, 235, 0.05);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 4px;
            margin-top: 0.25rem;
        }

        .info-text {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.65rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .info-text i {
            color: var(--primary-color);
            font-size: 0.65rem;
        }

        .info-text.updated {
            color: var(--secondary-color);
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(37, 99, 235, 0.1);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group select,
            .control-group input {
                min-width: 100%;
            }

            .nav-links {
                display: none;
            }
        }

        /* Preset Filter Badge - Compact */
        .preset-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 6px;
            font-size: 0.75rem;
            color: #a78bfa;
        }

        .preset-badge i {
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>MySwan Trading Dashboard</h1>
            </div>
            <nav class="nav-links">
                <a href="index.html" class="active"><i class="fas fa-home"></i> Dashboard</a>
                <a href="guaranteed-explosive.html"><i class="fas fa-rocket"></i> üéØ Top 3 Picks</a>
                <a href="explosive-scores-grid.html"><i class="fas fa-table-cells"></i> All Scores Grid</a>
                <a href="guaranteed-picks-history.html"><i class="fas fa-history"></i> Picks History</a>
                <a href="classic.html"><i class="fas fa-table"></i> Classic View</a>
                <a href="watchlist.html"><i class="fas fa-eye"></i> Watchlist</a>
                <a href="futures.html"><i class="fas fa-money-bill-trend"></i> Futures</a>
                <a href="patterns.html"><i class="fas fa-chart-area"></i> Patterns</a>
                <a href="picks.html"><i class="fas fa-star"></i> Picks</a>
                <a href="ticker-groups.html"><i class="fas fa-object-group"></i> Groups</a>
                <a href="discover.html"><i class="fas fa-search"></i> Discover</a>
                <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Stats Cards - HIDDEN (to show: remove style="display: none;") -->
        <div class="stats-grid" style="display: none;">
            <div class="stat-card" onclick="selectCollection('stocks')">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="stockCount">-</div>
                        <div class="stat-label">Total Stocks</div>
                    </div>
                    <div class="stat-icon blue">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> Active Trading
                </div>
            </div>

            <div class="stat-card" onclick="selectCollection('masters')">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="masterCount">-</div>
                        <div class="stat-label">Master Symbols</div>
                    </div>
                    <div class="stat-icon green">
                        <i class="fas fa-database"></i>
                    </div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-check-circle"></i> Watchlist Ready
                </div>
            </div>

            <div class="stat-card" onclick="selectCollection('futures')">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="futuresCount">-</div>
                        <div class="stat-label">Futures Contracts</div>
                    </div>
                    <div class="stat-icon purple">
                        <i class="fas fa-money-bill-trend"></i>
                    </div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-trend-up"></i> Live Markets
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="filteredCount">-</div>
                        <div class="stat-label">Filtered Results</div>
                    </div>
                    <div class="stat-icon orange">
                        <i class="fas fa-filter"></i>
                    </div>
                </div>
                <div class="stat-change" id="filterStatus">
                    <i class="fas fa-info-circle"></i> No filters applied
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-header">
                <h2>
                    <i class="fas fa-sliders"></i>
                    Data Controls
                </h2>
                <div id="activePreset" style="display: none;" class="preset-badge">
                    <i class="fas fa-magic"></i>
                    <span id="presetName">No Preset</span>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label for="collectionSelect">Collection</label>
                    <select id="collectionSelect">
                        <option value="masters">Master Symbols</option>
                        <option value="stocks" selected>Stocks</option>
                        <option value="futures">Futures</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="presetFilterSelect">Preset Filters</label>
                    <select id="presetFilterSelect">
                        <option value="none">-- No Preset --</option>
                        <!-- Use exact primaryCategory values (value must match the column cell value) -->
                        <option value="1-Explosive">üöÄ 1 - Explosive</option>
                        <option value="2-Oversold">üíé 2 - Oversold</option>
                        <option value="3-Downtrend Reversal">üîÅ 3 - Downtrend Reversal</option>
                        <option value="4-MomentumPop">üéØ 4 - Momentum Pop</option>
                        <option value="5-Breakout Watch">üî• 5 - Breakout Watch</option>
                        <option value="6-Trend Continuation">üìà 6 - Trend Continuation</option>
                        <option value="7-Overextended">‚ö° 7 - Overextended</option>
                    </select>
                </div>

                <button class="btn btn-success" id="applyPresetBtn">
                    <i class="fas fa-magic"></i> Apply Preset
                </button>

                <button class="btn btn-primary" id="reloadBtn">
                    <i class="fas fa-sync"></i> Reload Data
                </button>

                <button class="btn btn-secondary" id="clearFiltersBtn">
                    <i class="fas fa-times"></i> Clear Filters
                </button>

                <button class="btn btn-secondary" id="exportBtn">
                    <i class="fas fa-download"></i> Export Excel
                </button>
            </div>

            <!-- Update Actions -->
            <div class="controls" style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <div style="margin-bottom: 10px; color: var(--text-secondary); font-size: 14px; font-weight: 600;">
                    <i class="fas fa-bolt"></i> Update Actions
                </div>

                <button class="btn btn-warning" id="updateFuturesBtn">
                    <i class="fas fa-money-bill-trend"></i> Fetch Futures
                </button>

                <button class="btn btn-info" id="updateBarchartDailyBtn">
                    <i class="fas fa-sun"></i> Barchart Daily
                </button>

                <button class="btn btn-info" id="updateBarchartIntradayBtn">
                    <i class="fas fa-clock"></i> Barchart Intraday
                </button>

                <button class="btn btn-warning" id="updateTradingViewBtn">
                    <i class="fas fa-chart-line"></i> Update TradingView
                </button>

                <button class="btn btn-info" id="fetchPatternsBtn">
                    <i class="fas fa-chart-area"></i> Fetch Patterns
                </button>

                <button class="btn btn-success" id="updateScoringBtn">
                    <i class="fas fa-calculator"></i> Calculate Scoring
                </button>
            </div>
        </div>

        <!-- Data Grid -->
        <div class="data-grid">
            <div class="grid-header">
                <h2>
                    <i class="fas fa-table"></i>
                    <span id="gridTitle">Stock Data</span>
                </h2>
                <div class="grid-actions">
                    <button class="btn btn-secondary" onclick="table.clearHeaderFilter()">
                        <i class="fas fa-eraser"></i> Clear Header Filters
                    </button>
                </div>
            </div>

            <div id="dataTable"></div>

            <div class="info-panel">
                <div class="info-text">
                    <i class="fas fa-info-circle"></i>
                    <span id="gridInfo">Loading data...</span>
                </div>
                <div class="info-text">
                    <i class="fas fa-calendar"></i>
                    <span id="lastUpdate">Last update: Never</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/[email protected]/dist/chart.umd.js"></script>

    <script>
        const API_BASE = "http://jpmaxtricks.com:8070/api";

        let table;
        let currentCollection = "stocks";
        let loadedTotal = 0;
        let filteredTotal = 0;
        let activePresetFn = null;

        // Helper functions from original index.html
        function getNested(row, path) {
            if (!row || !path) return null;
            const parts = path.split('.');
            let cur = row;
            for (const p of parts) {
                if (cur == null) return null;
                cur = cur[p];
            }
            return cur;
        }

        function numericHeaderFilter(headerValue, rowValue, rowData, filterParams){
            if(headerValue === null || headerValue === undefined) return true;
            const s = String(headerValue).trim();
            if(s === '') return true;
            const opMatch = s.match(/^([><]=?)\s*(-?\d+(?:\.\d+)?)$/);
            let rv = Number(rowValue);
            if(isNaN(rv)) rv = null;
            if(opMatch){
                const op = opMatch[1];
                const num = parseFloat(opMatch[2]);
                if(rv === null) return false;
                switch(op){
                    case '>': return rv > num;
                    case '>=': return rv >= num;
                    case '<': return rv < num;
                    case '<=': return rv <= num;
                }
            }
            const rangeMatch = s.match(/^(-?\d+(?:\.\d+)?)\s*-\s*(-?\d+(?:\.\d+)?)$/);
            if(rangeMatch){
                const low = parseFloat(rangeMatch[1]);
                const high = parseFloat(rangeMatch[2]);
                if(rv === null) return false;
                return rv >= Math.min(low, high) && rv <= Math.max(low, high);
            }
            const numMatch = s.match(/^-?\d+(?:\.\d+)?$/);
            if(numMatch){
                const num = parseFloat(numMatch[0]);
                if(rv === null) return false;
                return rv === num;
            }
            if(rowValue === null || rowValue === undefined) return false;
            return String(rowValue).toLowerCase().indexOf(s.toLowerCase()) !== -1;
        }

        // Column definitions (complete from index.html)
        const columnsMaster = [
            {title: "Ticker", field: "ticker", headerFilter: "input", width: 80},
            {title: "Name", field: "name", headerFilter: "input", width: 200},
            {title: "Type", field: "type", headerFilter: "input", width: 70},
            {title: "Added Price", field: "addedPrice", headerFilter: "input", width: 90},
            {title: "Added Date", field: "addedDate", headerFilter: "input", width: 100},
            {
                title: "eTrade",
                field: "etradePatternLookup",
                width: 100,
                hozAlign: "center",
                headerFilter: "select",
                headerFilterParams: {values: {"": "All", "true": "Y", "false": "N"}},
                formatter: function(cell) {
                    const value = cell.getValue();
                    const ticker = cell.getRow().getData().ticker;
                    const checked = value === true ? 'checked' : '';
                    const bgColor = value === true ? '#22c55e' : '#ef4444';
                    const textColor = '#fff';
                    const label = value === true ? 'Y' : 'N';
                    return `
                        <label style="display: inline-flex; align-items: center; cursor: pointer; padding: 2px 8px; border-radius: 4px; background: ${bgColor}; color: ${textColor}; font-weight: bold; font-size: 11px;">
                            <input type="checkbox" ${checked}
                                   onchange="toggleEtradePattern('${ticker}', this.checked)"
                                   style="margin-right: 4px;">
                            ${label}
                        </label>
                    `;
                }
            }
        ];

        const columnsStock = [
            {
                title: "üìå",
                field: "pickAction",
                width: 50,
                hozAlign: "center",
                headerSort: false,
                formatter: function(cell) {
                    return '<button class="add-pick-btn" style="padding: 2px 6px; background: #10b981; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;" title="Add to Picks">+</button>';
                },
                cellClick: function(e, cell) {
                    const rowData = cell.getRow().getData();
                    addStockToPicks(rowData);
                }
            },
            {
                title: "üëÅ",
                field: "watchlistAction",
                width: 50,
                hozAlign: "center",
                headerSort: false,
                formatter: function(cell) {
                    return '<button class="add-watch-btn" style="padding: 2px 6px; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;" title="Add to Watchlist">+</button>';
                },
                cellClick: function(e, cell) {
                    const rowData = cell.getRow().getData();
                    addStockToWatchlist(rowData);
                }
            },
            {title: "Ticker", field: "ticker", headerFilter: "input", headerFilterPlaceholder: "AAPL", width: 85, formatter:function(cell){
                const ticker = cell.getValue();
                if(!ticker) return "";
                const longCount = cell.getRow().getData().noOfLongPatterns || 0;
                const shortCount = cell.getRow().getData().noOfShortPatterns || 0;
                const hasPatterns = longCount > 0 || shortCount > 0;
                let html = `<a href="stock-history.html?ticker=${encodeURIComponent(ticker)}" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 600;">${ticker}</a>`;
                if(hasPatterns) {
                    html += ` <a href="patterns.html?ticker=${encodeURIComponent(ticker)}" target="_blank" style="color: #a78bfa; text-decoration: none; font-size: 0.85em; margin-left: 3px;" title="View ${longCount} long, ${shortCount} short patterns"><i class="fas fa-chart-area"></i></a>`;
                }
                return html;
            }},
            {title: "Chg", field: "change", headerFilter: "input", headerFilterPlaceholder: ">0 or <-5", headerFilterFunc: numericHeaderFilter, width: 70, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #22c55e;">‚ñ≤ ${val.toFixed(2)}</span>`; if (val < 0) return `<span style="color: #ef4444;">‚ñº ${val.toFixed(2)}</span>`; return val; }},
            {title: "Low", field: "low", headerFilter: "input", headerFilterPlaceholder: ">=10", headerFilterFunc: numericHeaderFilter, width: 60},
            {title: "Price", field: "price", headerFilter: "input", headerFilterPlaceholder: ">100", headerFilterFunc: numericHeaderFilter, width: 60},
            {title: "High", field: "high", headerFilter: "input", headerFilterPlaceholder: "<=500", headerFilterFunc: numericHeaderFilter, width: 60},
            {title: "pickScore", field: "dailyRank.pickScore", headerFilter: "input", headerFilterPlaceholder: "<=500", headerFilterFunc: numericHeaderFilter, width: 60},
            {title: "Rank", field: "dailyRank.finalRank", headerFilter: "input", headerFilterPlaceholder: "<=500", headerFilterFunc: numericHeaderFilter, width: 50},
            {title: "Safe", field: "dailyRank.safetyRank", headerFilter: "input", headerFilterPlaceholder: "<=500", headerFilterFunc: numericHeaderFilter, width: 50},
            {title: "Alloc", field: "dailyRank.allocation", headerFilter: "input", headerFilterPlaceholder: "<=500", headerFilterFunc: numericHeaderFilter, width: 50},
            {title: "PrimCat", field: "filterCategory.primaryCategory", headerFilter: "input", headerFilterPlaceholder: "<=500", headerFilterFunc: numericHeaderFilter, width: 70, sorter:function(a,b){
                // custom sorter: extract leading integer from values like "1-Explosive" or "99-NO-SETUP"
                function leadingNum(v){
                    if(v === null || v === undefined) return Number.MAX_SAFE_INTEGER;
                    var s = String(v).trim();
                    var m = s.match(/^(\d+)/);
                    return m ? parseInt(m[1], 10) : Number.MAX_SAFE_INTEGER;
                }
                var na = leadingNum(a);
                var nb = leadingNum(b);
                if(na !== nb) return na - nb;
                // tie-breaker: compare full string (case-insensitive)
                var sa = (a === null || a === undefined) ? '' : String(a).toLowerCase();
                var sb = (b === null || b === undefined) ? '' : String(b).toLowerCase();
                if(sa < sb) return -1;
                if(sa > sb) return 1;
                return 0;
            }},
            {title: "CatList", field: "filterCategory.category", headerFilter: "input", headerFilterPlaceholder: "<=500", headerFilterFunc: numericHeaderFilter, width: 70},
            {title: "Bottom", field: "bottom.bottom", headerFilter: "input", headerFilterPlaceholder: "true", width: 70, hozAlign: "center", formatter: function(cell){ const v = cell.getValue(); return (v === true || v === 'true') ? "‚úÖ" : ""; }},
            {title: "BotMet", field: "bottom.conditionsMet", headerFilter: "input", headerFilterPlaceholder: ">=5", headerFilterFunc: numericHeaderFilter, width: 70, hozAlign: "center"},
            {title: "BotStr", field: "bottom.strength", headerFilter: "input", headerFilterPlaceholder: "STRONG", width: 80, hozAlign: "center"},
            {title: "SpkLikely", field: "spike.spikeLikely", headerFilter: "input", headerFilterPlaceholder: "true", width: 80, hozAlign: "center"},
            {title: "SpkScore", field: "spike.spikeScore", headerFilter: "input", headerFilterPlaceholder: ">=70", headerFilterFunc: numericHeaderFilter, width: 80, hozAlign: "center"},
            {title: "SpkType", field: "spike.spikeType", headerFilter: "input", headerFilterPlaceholder: "VOLUME", width: 80, hozAlign: "center"},
            {title: "Overall", field: "score.overallScore", headerFilter: "input", headerFilterPlaceholder: ">=65", headerFilterFunc: numericHeaderFilter, width: 70},
            {title: "L#", field: "noOfLongPatterns", headerFilter: "input", headerFilterPlaceholder: ">=1", headerFilterFunc: numericHeaderFilter, width: 30 },
            {title: "S#", field: "noOfShortPatterns", headerFilter: "input", headerFilterPlaceholder: ">=1", headerFilterFunc: numericHeaderFilter, width: 30},
            {title: "Up‚Üë", field: "upDays", headerFilter: "input", headerFilterPlaceholder: ">=3", headerFilterFunc: numericHeaderFilter, width: 40, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #22c55e; font-weight: 600;">${val}</span>`; return val; }},
            {title: "UpHi", field: "upHigh", headerFilter: "input", headerFilterPlaceholder: ">100", headerFilterFunc: numericHeaderFilter, width: 40, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #22c55e;">${val.toFixed(2)}</span>`; return '-'; }},
            {title: "Dn‚Üì", field: "downDays", headerFilter: "input", headerFilterPlaceholder: ">=3", headerFilterFunc: numericHeaderFilter, width: 40, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #ef4444; font-weight: 600;">${val}</span>`; return val; }},
            {title: "DnLo", field: "downLow", headerFilter: "input", headerFilterPlaceholder: "<100", headerFilterFunc: numericHeaderFilter, width: 40, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #ef4444;">${val.toFixed(2)}</span>`; return '-'; }},
            {title: "OvrSold", field: "oversold.oversoldBounce", headerFilter: "input", headerFilterPlaceholder: "true", width: 70, formatter: function(cell){ const v = cell.getValue(); return (v === true || v === 'true') ? "‚úÖ" : ""; }},
            {title: "OSScore", field: "oversold.bounceScore", headerFilter: "input", headerFilterPlaceholder: ">=5", headerFilterFunc: numericHeaderFilter, width: 70, hozAlign: "center"},
            {title: "OSType", field: "oversold.bounceType", headerFilter: "input", headerFilterPlaceholder: "STRONG", width: 80, hozAlign: "center"},{title: "Signal", field: "score.signal", headerFilter: "input", headerFilterPlaceholder: "BUY", width: 70, formatter: function(cell) { const val = cell.getValue(); if (val === 'BUY') return `<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; if (val === 'SELL') return `<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; return val; }},
            {title: "SigD", field: "score.signalDays", headerFilter: "input", headerFilterPlaceholder: "BUY", width: 70, formatter: function(cell) { const val = cell.getValue(); if (val === 'BUY') return `<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; if (val === 'SELL') return `<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; return val; }},
            {title: "BTShort", field: "rating.btShortRating", headerFilter: "input", headerFilterPlaceholder: "Buy", width: 80},
            {title: "BTLong", field: "rating.btLongRating", headerFilter: "input", headerFilterPlaceholder: "Buy", width: 80},
            {title: "BT", field: "rating.btRating", headerFilter: "input", headerFilterPlaceholder: "Buy", width: 80},
            {title: "BTTrend", field: "rating.btTrend", headerFilter: "input", headerFilterPlaceholder: "Up", width: 80},
            {title: "TVMA", field: "rating.tradingViewMARating", headerFilter: "input", headerFilterPlaceholder: "StrongBuy", width: 80},
            {title: "TVTech", field: "rating.tradingViewTechRating", headerFilter: "input", headerFilterPlaceholder: "Buy", width: 80},
            {title: "TVAnaly", field: "rating.tradingViewAnalystsRating", headerFilter: "input", headerFilterPlaceholder: "Buy", width: 80},
           {title: "DT", field: "score.dayTradingScore", headerFilter: "input", headerFilterPlaceholder: ">=20", headerFilterFunc: numericHeaderFilter, width: 60},
            {title: "ST", field: "score.swingTradingScore", headerFilter: "input", headerFilterPlaceholder: ">=20", headerFilterFunc: numericHeaderFilter, width: 60},
            {title: "Revsl", field: "score.reversalScore", headerFilter: "input", headerFilterPlaceholder: ">=10", headerFilterFunc: numericHeaderFilter, width: 65},
            {title: "Brkout", field: "score.breakoutScore", headerFilter: "input", headerFilterPlaceholder: ">=60", headerFilterFunc: numericHeaderFilter, width: 70},
            {title: "Patrn", field: "score.patternScore", headerFilter: "input", headerFilterPlaceholder: ">=10", headerFilterFunc: numericHeaderFilter, width: 65},
            {title: "BotReasons", field: "bottom.reasons", headerFilter: "input", width: 150, formatter: function(cell){ const v = cell.getValue(); if (!v) return ""; if (Array.isArray(v)) return v.join(', '); return v; }},
            {title: "SpkReasons", field: "spike.reasons", headerFilter: "input", width: 150, formatter: function(cell){ const v = cell.getValue(); if (!v) return ""; if (Array.isArray(v)) return v.join(', '); return v; }},
            {title: "DTR", field: "score.dayTradingReason", headerFilter: "input", width: 120},
            {title: "STR", field: "score.swingTradingReason", headerFilter: "input", width: 120},
            {title: "RevR", field: "score.reversalReason", headerFilter: "input", width: 120},
            {title: "BrkR", field: "score.breakoutReason", headerFilter: "input", width: 120},
            {title: "PatR", field: "score.patternReason", headerFilter: "input", width: 120},
        ];

        const columnsFutures = [
            {title: "Ticker", field: "ticker", headerFilter: "input", headerFilterPlaceholder: "GC", width: 90, formatter:function(cell){ const v = cell.getValue(); if(!v) return ""; return `<a href="futures-history.html?ticker=${encodeURIComponent(v)}" target="_blank" style="color: #3b82f6; text-decoration: none;">${v}</a>`; }},
            {title: "Type", field: "type", headerFilter: "input", headerFilterPlaceholder: "FUTURE", width: 70},
            {title: "Price", field: "price", headerFilter: "input", headerFilterPlaceholder: ">100", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "Change", field: "change", headerFilter: "input", headerFilterPlaceholder: ">0", headerFilterFunc: numericHeaderFilter, width: 80, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #22c55e;">‚ñ≤ ${val.toFixed(2)}</span>`; if (val < 0) return `<span style="color: #ef4444;">‚ñº ${val.toFixed(2)}</span>`; return val; }},
            {title: "Open", field: "open", headerFilter: "input", headerFilterPlaceholder: ">=100", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "High", field: "high", headerFilter: "input", headerFilterPlaceholder: ">=100", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "Low", field: "low", headerFilter: "input", headerFilterPlaceholder: ">=100", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "Volume", field: "volume", headerFilter: "input", headerFilterPlaceholder: ">1000", headerFilterFunc: numericHeaderFilter, width: 100},
            {title: "OpenInt", field: "openInterest", headerFilter: "input", headerFilterPlaceholder: ">100", headerFilterFunc: numericHeaderFilter, width: 90},
            {title: "ExpDate", field: "expiryDate", headerFilter: "input", headerFilterPlaceholder: "2025", width: 100},
            {title: "ExpDays", field: "expiryDays", headerFilter: "input", headerFilterPlaceholder: "<30", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "PrevClose", field: "prevClose", headerFilter: "input", headerFilterPlaceholder: ">=100", headerFilterFunc: numericHeaderFilter, width: 90},
            {title: "UpHigh", field: "upHigh", headerFilter: "input", headerFilterPlaceholder: ">=100", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "DnLow", field: "downLow", headerFilter: "input", headerFilterPlaceholder: ">=100", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "BTShort", field: "rating.btShortRating", headerFilter: "input", width: 80},
            {title: "BTLong", field: "rating.btLongRating", headerFilter: "input", width: 80},
            {title: "BT", field: "rating.btRating", headerFilter: "input", width: 80},
            {title: "BTTrend", field: "rating.btTrend", headerFilter: "input", width: 80},
            {title: "HistDate", field: "histDate", headerFilter: "input", width: 100},
        ];

        // Preset filter functions
        function filterExplosive(row) {
            const spikeScore = Number(getNested(row, 'spike.spikeScore')) || 0;
            const bottomConds = Number(getNested(row, 'bottom.conditionsMet')) || 0;
            const breakoutScore = Number(getNested(row, 'score.breakoutScore')) || 0;
            const overallScore = Number(getNested(row, 'score.overallScore')) || 0;
            const signal = (getNested(row, 'score.signal') || '').toString().toUpperCase();
            return spikeScore >= 70 && bottomConds >= 5 && breakoutScore >= 60 && overallScore >= 65 && signal === 'BUY';
        }

        function filterPreset2(row) { return false; }
        function filterPreset3(row) { return false; }
        function filterPreset4(row) { return false; }
        function filterPreset5(row) { return false; }
        function filterPreset6(row) { return false; }
        function filterPreset7(row) { return false; }
        function filterPreset8(row) { return false; }

        function applyPresetByName(name) {
            clearActivePreset();
            if (!table || name === 'none') {
                document.getElementById('activePreset').style.display = 'none';
                return;
            }

            // If the selected preset looks like a PrimCat value (e.g. '1-Explosive'),
            // apply an exact (case-insensitive) equality filter against the column.
            try {
                const s = String(name || '').trim();
                const primMatch = s.match(/^\d+-/);
                if (primMatch) {
                    try { table.clearFilter(true); } catch (e) { /* ignore */ }
                    table.setFilter(function(row){
                        const val = getNested(row, 'filterCategory.primaryCategory');
                        if (val === null || val === undefined) return false;
                        return String(val).trim().toUpperCase() === s.toUpperCase();
                    });

                    document.getElementById('activePreset').style.display = 'flex';
                    document.getElementById('presetName').textContent = s;
                    document.getElementById('filterStatus').innerHTML = '<i class="fas fa-filter"></i> PrimCat = ' + s;
                    document.getElementById('filterStatus').className = 'stat-change positive';
                    try { filteredTotal = table.getData(true).length; } catch (e) { filteredTotal = table.getData().length; }
                    updateGridInfo();
                    return;
                }
            } catch (err) {
                console.warn('PrimCat filter application failed', err);
            }

            // Legacy named presets (non-PrimCat) - keep existing behavior
            let fn, displayName;
            switch (name) {
                case 'explosive': fn = filterExplosive; displayName = 'EXPLOSIVE 4-7 DAY'; break;
                case 'filter2': fn = filterPreset2; displayName = 'High Value Stocks'; break;
                case 'filter3': fn = filterPreset3; displayName = 'Momentum Leaders'; break;
                case 'filter4': fn = filterPreset4; displayName = 'Breakout Candidates'; break;
                case 'filter5': fn = filterPreset5; displayName = 'Quick Gains'; break;
                case 'filter6': fn = filterPreset6; displayName = 'Hot Picks'; break;
                case 'filter7': fn = filterPreset7; displayName = 'Value Plays'; break;
                case 'filter8': fn = filterPreset8; displayName = 'Top Rated'; break;
                default: fn = null;
            }

            if (fn) {
                try {
                    table.addFilter(fn);
                    activePresetFn = fn;
                    document.getElementById('activePreset').style.display = 'flex';
                    document.getElementById('presetName').textContent = displayName;
                    document.getElementById('filterStatus').innerHTML = '<i class="fas fa-filter"></i> Preset filter active';
                    document.getElementById('filterStatus').className = 'stat-change positive';
                    try { filteredTotal = table.getData(true).length; } catch (e) { }
                    updateGridInfo();
                } catch (e) {
                    console.error('Failed to apply preset filter', e);
                }
            }
        }

        function clearActivePreset() {
            if (!table) return;
            if (activePresetFn) {
                try { table.removeFilter(activePresetFn); } catch (e) { }
                activePresetFn = null;
                document.getElementById('activePreset').style.display = 'none';
                document.getElementById('filterStatus').innerHTML = '<i class="fas fa-info-circle"></i> No filters applied';
                document.getElementById('filterStatus').className = 'stat-change';
                try { filteredTotal = table.getData(true).length; } catch (e) { filteredTotal = loadedTotal; }
                updateGridInfo();
            }
        }

        function createTable(columns) {
            if (table) {
                table.setColumns(columns);
                return;
            }

            table = new Tabulator("#dataTable", {
                layout: "fitData",
                height: "calc(100vh - 120px)",
                pagination: true,
                paginationSize: 100,
                paginationSizeSelector: [50, 100, 200, 500],
                columns: columns,
                placeholder: "No data available - Select a collection and click Reload",
                rowHeight: 28,
                headerFilterPlaceholder: "",
                columnDefaults: {
                    resizable: true,
                    headerSort: true,
                    tooltip: true,
                    minWidth: 70,
                    headerWordWrap: true,
                },
                virtualDomBuffer: 300,
                textSize: 9,
            });

            // Event handlers for filter tracking
            if (table && typeof table.on === 'function') {
                try {
                    table.on('dataFiltered', function(filters, rows){
                        try {
                            filteredTotal = Array.isArray(rows) ? rows.length : table.getData(true).length;
                        } catch (e) { }
                        updateGridInfo();
                    });
                } catch (e) { }
            }
        }

        async function loadData() {
            const collection = document.getElementById('collectionSelect').value;
            currentCollection = collection;

            let url, columns, title;
            if (collection === 'masters') {
                url = `${API_BASE}/master/list`;
                columns = columnsMaster;
                title = "Master Symbols";
            } else if (collection === 'stocks') {
                url = `${API_BASE}/stock/list`;
                columns = columnsStock;
                title = "Stock Data";
            } else if (collection === 'futures') {
                url = `${API_BASE}/futures/list`;
                columns = columnsFutures;
                title = "Futures Contracts";
            }

            console.log('=== Loading Data ===');
            console.log('Collection:', collection);
            console.log('URL:', url);
            console.log('API_BASE:', API_BASE);

            document.getElementById('gridTitle').textContent = title;

            // Always create table first
            try {
                createTable(columns);
                console.log('Table created/updated with columns');
            } catch (e) {
                console.error('Error creating table:', e);
            }

            try {
                console.log('Fetching from:', url);
                const response = await fetch(url);
                console.log('Response received - Status:', response.status, 'OK:', response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Data parsed - Type:', typeof data, 'IsArray:', Array.isArray(data));
                console.log('Data length:', Array.isArray(data) ? data.length : 'N/A');
                console.log('First item sample:', Array.isArray(data) && data.length > 0 ? data[0] : data);

                const rows = Array.isArray(data) ? data : (data ? [data] : []);
                console.log('Rows to display:', rows.length);

                loadedTotal = rows.length || 0;
                filteredTotal = loadedTotal;

                if (table) {
                    console.log('Replacing table data with', rows.length, 'rows...');
                    await table.replaceData(rows);
                    console.log('‚úì Table data replaced successfully');
                } else {
                    console.error('Table not initialized!');
                }

                updateGridInfo();
                updateCounts();
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const fullTimestamp = now.toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const lastUpdateEl = document.getElementById('lastUpdate');
                lastUpdateEl.textContent = `Last update: ${dateStr} at ${timeStr}`;
                lastUpdateEl.title = `Full timestamp: ${fullTimestamp}`;
                lastUpdateEl.style.cursor = 'help';

                // Add visual update indicator
                lastUpdateEl.parentElement.classList.add('updated');
                setTimeout(() => lastUpdateEl.parentElement.classList.remove('updated'), 1000);

                console.log('=== Load Complete ===');
            } catch (err) {
                console.error('=== ERROR Loading Data ===');
                console.error('Error type:', err.name);
                console.error('Error message:', err.message);
                console.error('Error stack:', err.stack);
                console.error('URL was:', url);
                alert(`Failed to load data from ${collection}:\n${err.message}\n\nCheck browser console (F12) for details.`);

                // Try to show empty table
                if (table) {
                    try {
                        await table.replaceData([]);
                    } catch (e) {
                        console.error('Could not clear table:', e);
                    }
                }
            }
        }

        function updateGridInfo() {
            const info = document.getElementById('gridInfo');
            const filtered = document.getElementById('filteredCount');

            info.textContent = `Showing ${filteredTotal} of ${loadedTotal} records | Page ${table ? (table.getPage() || 1) : 1} of ${table ? (table.getPageMax() || 1) : 1}`;
            filtered.textContent = filteredTotal;
        }

        // Cache for counts to avoid duplicate API calls
        let cachedCounts = { stocks: 0, masters: 0, futures: 0 };

        async function updateCounts() {
            console.log('Updating counts...');
            try {
                // Only fetch counts for collections NOT currently loaded in the table
                // This avoids duplicate API calls when reloading data
                const promises = [];
                const collections = [];

                if (currentCollection !== 'stocks') {
                    promises.push(fetch(`${API_BASE}/stock/list`).then(r => r.ok ? r.json() : []).catch(() => []));
                    collections.push('stocks');
                }
                if (currentCollection !== 'masters') {
                    promises.push(fetch(`${API_BASE}/master/list`).then(r => r.ok ? r.json() : []).catch(() => []));
                    collections.push('masters');
                }
                if (currentCollection !== 'futures') {
                    promises.push(fetch(`${API_BASE}/futures/list`).then(r => r.ok ? r.json() : []).catch(() => []));
                    collections.push('futures');
                }

                // Fetch only the collections we need
                const results = await Promise.all(promises);

                // Update cached counts for fetched collections
                results.forEach((data, index) => {
                    const collectionName = collections[index];
                    cachedCounts[collectionName] = Array.isArray(data) ? data.length : 0;
                });

                // For the current collection, use the loaded data count
                if (currentCollection === 'stocks' && loadedTotal > 0) {
                    cachedCounts.stocks = loadedTotal;
                } else if (currentCollection === 'masters' && loadedTotal > 0) {
                    cachedCounts.masters = loadedTotal;
                } else if (currentCollection === 'futures' && loadedTotal > 0) {
                    cachedCounts.futures = loadedTotal;
                }

                document.getElementById('stockCount').textContent = cachedCounts.stocks;
                document.getElementById('masterCount').textContent = cachedCounts.masters;
                document.getElementById('futuresCount').textContent = cachedCounts.futures;

                console.log('Counts updated - Stocks:', cachedCounts.stocks, 'Masters:', cachedCounts.masters, 'Futures:', cachedCounts.futures);
            } catch (e) {
                console.error('Failed to update counts:', e);
                document.getElementById('stockCount').textContent = '?';
                document.getElementById('masterCount').textContent = '?';
                document.getElementById('futuresCount').textContent = '?';
            }
        }

        function selectCollection(coll) {
            document.getElementById('collectionSelect').value = coll;
            loadData();
        }

        function clearFilters() {
            if (table) {
                table.clearFilter(true);
                table.clearHeaderFilter();
                clearActivePreset();
                filteredTotal = loadedTotal;
                updateGridInfo();
            }
        }

        async function addStockToPicks(stockData) {
            if (!confirm(`Add ${stockData.ticker} to picks?`)) return;

            const pick = {
                ticker: stockData.ticker,
                reason: `Score: ${stockData.score?.overallScore || 0}, Signal: ${stockData.score?.signal || 'N/A'}`,
                entry: stockData.price,
                target: stockData.price * 1.05, // Default 5% target
                stopLoss: stockData.price * 0.95, // Default 5% stop
                targetDate: null,
                addedDate: new Date().toISOString().split('T')[0],
                addedPrice: stockData.price,
                targetMet: false,
                stopLossMet: false,
                noOfLongPatterns: stockData.noOfLongPatterns || 0,
                noOfShortPatterns: stockData.noOfShortPatterns || 0,
                overAllScore: stockData.score?.overallScore || 0,
                bottomScore: stockData.bottom?.conditionsMet || 0,
                reversalScore: stockData.score?.reversalScore || 0,
                breakoutScore: stockData.score?.breakoutScore || 0,
                patternScore: stockData.score?.patternScore || 0,
                spikeScore: stockData.spike?.spikeScore || 0,
                signal: stockData.score?.signal || '',
                btShortRating: stockData.rating?.btShortRating || '',
                btLongRating: stockData.rating?.btLongRating || '',
                btRating: stockData.rating?.btRating || '',
                btTrend: stockData.rating?.btTrend || '',
                tradingViewTechRating: stockData.rating?.tradingViewTechRating || '',
                tradingViewMARating: stockData.rating?.tradingViewMARating || '',
                tradingViewOSRating: stockData.rating?.tradingViewOSRating || ''
            };

            try {
                const response = await fetch(`${API_BASE}/picks/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pick)
                });

                if (response.ok) {
                    alert(`‚úì ${stockData.ticker} added to picks!`);
                } else {
                    throw new Error('Failed to add pick');
                }
            } catch (error) {
                console.error('Error adding to picks:', error);
                alert('Failed to add to picks: ' + error.message);
            }
        }

        async function addStockToWatchlist(stockData) {
            if (!confirm(`Add ${stockData.ticker} to watchlist?`)) return;

            try {
                const response = await fetch(`${API_BASE}/watchlist/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: stockData.ticker })
                });

                if (response.ok) {
                    alert(`‚úì ${stockData.ticker} added to watchlist!`);
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
            } catch (error) {
                console.error('Error adding to watchlist:', error);
                alert('Failed to add to watchlist: ' + error.message);
            }
        }

        function exportExcel() {
            if (!table) return;
            const data = table.getData();
            if (!data.length) return alert('No data to export');

            // Flatten nested objects for Excel export
            const flattenedData = data.map(row => {
                const flatRow = {
                    ticker: row.ticker,
                    change: row.change,
                    low: row.low,
                    price: row.price,
                    high: row.high,
                    open: row.open,
                    volume: row.volume,

                    // Bottom fields
                    'bottom.bottom': row.bottom?.bottom,
                    'bottom.conditionsMet': row.bottom?.conditionsMet,
                    'bottom.strength': row.bottom?.strength,
                    'bottom.reasons': Array.isArray(row.bottom?.reasons) ? row.bottom.reasons.join(', ') : row.bottom?.reasons,

                    // Spike fields
                    'spike.spikeLikely': row.spike?.spikeLikely,
                    'spike.spikeScore': row.spike?.spikeScore,
                    'spike.spikeType': row.spike?.spikeType,
                    'spike.reasons': Array.isArray(row.spike?.reasons) ? row.spike.reasons.join(', ') : row.spike?.reasons,

                    // Score fields
                    'score.overallScore': row.score?.overallScore,
                    'score.signal': row.score?.signal,
                    'score.dayTradingScore': row.score?.dayTradingScore,
                    'score.swingTradingScore': row.score?.swingTradingScore,
                    'score.reversalScore': row.score?.reversalScore,
                    'score.breakoutScore': row.score?.breakoutScore,
                    'score.patternScore': row.score?.patternScore,
                    'score.dayTradingReason': row.score?.dayTradingReason,
                    'score.swingTradingReason': row.score?.swingTradingReason,
                    'score.reversalReason': row.score?.reversalReason,
                    'score.breakoutReason': row.score?.breakoutReason,
                    'score.patternReason': row.score?.patternReason,

                    // Rating fields
                    'rating.btShortRating': row.rating?.btShortRating,
                    'rating.btLongRating': row.rating?.btLongRating,
                    'rating.btRating': row.rating?.btRating,
                    'rating.btTrend': row.rating?.btTrend,
                    'rating.tradingViewMARating': row.rating?.tradingViewMARating,
                    'rating.tradingViewTechRating': row.rating?.tradingViewTechRating,
                    'rating.tradingViewAnalystsRating': row.rating?.tradingViewAnalystsRating,

                    // Pattern counts
                    noOfLongPatterns: row.noOfLongPatterns,
                    noOfShortPatterns: row.noOfShortPatterns,

                    // Consecutive days
                    upDays: row.upDays,
                    upHigh: row.upHigh,
                    downDays: row.downDays,
                    downLow: row.downLow,

                    // Additional fields
                    type: row.type,
                    histDate: row.histDate,
                    prevClose: row.prevClose,
                    momentum: row.momentum,
                    sma9: row.sma9,
                    sma20: row.sma20,
                    sma50: row.sma50,
                    sma200: row.sma200,
                    ema9: row.ema9,
                    ema20: row.ema20,
                    ema50: row.ema50,
                    ema200: row.ema200,
                    rsi14: row.rsi14,
                    macd1226: row.macd1226,
                    atr14: row.atr14,
                    vwap: row.vwap,
                    avgVolume10D: row.avgVolume10D,
                    volumeChange: row.volumeChange,
                    priceChg5D: row.priceChg5D,
                    priceChg10D: row.priceChg10D,
                    priceChg20D: row.priceChg20D,
                    low52: row.low52,
                    high52: row.high52,
                    earningsDate: row.earningsDate,
                    earningDays: row.earningDays
                };

                return flatRow;
            });

            const ws = XLSX.utils.json_to_sheet(flattenedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, currentCollection);
            XLSX.writeFile(wb, `myswan-${currentCollection}-${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // Toggle eTrade Pattern Function
        async function toggleEtradePattern(ticker, enabled) {
            try {
                const response = await fetch(`${API_BASE}/master/${encodeURIComponent(ticker)}/etrade-pattern?enabled=${enabled}`, {
                    method: 'PATCH'
                });

                if (response.ok) {
                    console.log(`eTrade Pattern for ${ticker} updated to: ${enabled ? 'Y' : 'N'}`);
                    // Update the row data in the table
                    if (table) {
                        const row = table.getRows().find(r => r.getData().ticker === ticker);
                        if (row) {
                            row.update({etradePatternLookup: enabled});
                        }
                    }
                } else {
                    alert(`Failed to update eTrade Pattern for ${ticker}`);
                    // Reload to revert the checkbox
                    loadData();
                }
            } catch (error) {
                console.error('Error updating eTrade Pattern:', error);
                alert(`Error: ${error.message}`);
                // Reload to revert the checkbox
                loadData();
            }
        }

        // Update Action Functions
        async function updateTradingView() {
            if (!confirm('Update TradingView data for all stocks? This may take several minutes.')) return;

            const btn = document.getElementById('updateTradingViewBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

            try {
                const response = await fetch(`${API_BASE}/external/updateTradingView`, { method: 'POST' });
                if (response.ok) {
                    alert('TradingView update completed successfully!');
                    loadData(); // Reload data to show updates
                } else {
                    alert('TradingView update failed. Check console for details.');
                }
            } catch (error) {
                console.error('Error updating TradingView:', error);
                alert('Error updating TradingView: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chart-line"></i> Update TradingView';
            }
        }

        async function updateBarchartDaily() {
            if (!confirm('Fetch Barchart daily quotes for all stocks? This may take several minutes.')) return;

            const btn = document.getElementById('updateBarchartDailyBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';

            try {
                const response = await fetch(`${API_BASE}/external/getDailyQuotes`, { method: 'POST' });
                if (response.ok) {
                    alert('Barchart daily quotes updated successfully!');
                    loadData();
                } else {
                    alert('Barchart daily update failed. Check console for details.');
                }
            } catch (error) {
                console.error('Error fetching Barchart daily quotes:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sun"></i> Barchart Daily';
            }
        }

        async function updateBarchartIntraday() {
            if (!confirm('Fetch Barchart intraday quotes for all stocks? This may take several minutes.')) return;

            const btn = document.getElementById('updateBarchartIntradayBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';

            try {
                const response = await fetch(`${API_BASE}/external/getIntraDayQuotes`, { method: 'POST' });
                if (response.ok) {
                    alert('Barchart intraday quotes updated successfully!');
                    loadData();
                } else {
                    alert('Barchart intraday update failed. Check console for details.');
                }
            } catch (error) {
                console.error('Error fetching Barchart intraday quotes:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-clock"></i> Barchart Intraday';
            }
        }

        async function updateScoring() {
            if (!confirm('Calculate scoring for all stocks? This may take several minutes.')) return;

            const btn = document.getElementById('updateScoringBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';

            try {
                const response = await fetch(`${API_BASE}/compute/process`, { method: 'POST' });
                if (response.ok) {
                    alert('Scoring calculation completed successfully!');
                    loadData();
                } else {
                    alert('Scoring calculation failed. Check console for details.');
                }
            } catch (error) {
                console.error('Error calculating scoring:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calculator"></i> Calculate Scoring';
            }
        }

        async function updateFutures() {
            if (!confirm('Fetch futures data from Barchart? This may take a few minutes.')) return;

            const btn = document.getElementById('updateFuturesBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';

            try {
                const response = await fetch(`${API_BASE}/external/futures/fetch-barchart`, { method: 'POST' });
                if (response.ok) {
                    alert('Futures data fetched successfully!');
                    loadData();
                } else {
                    alert('Futures fetch failed. Check console for details.');
                }
            } catch (error) {
                console.error('Error fetching futures:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-money-bill-trend"></i> Fetch Futures';
            }
        }

        async function fetchPatterns() {
            if (!confirm('Fetch eTrade patterns for all enabled stocks? This will process stocks in parallel batches of 50. May take several minutes.')) return;

            const btn = document.getElementById('fetchPatternsBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';

            try {
                const response = await fetch(`${API_BASE}/external/pattern/fetch-etrade`, { method: 'POST' });
                if (response.ok) {
                    const result = await response.text();
                    alert('Patterns fetched successfully!\n' + result);
                    loadData();
                } else {
                    alert('Pattern fetch failed. Check console for details.');
                }
            } catch (error) {
                console.error('Error fetching patterns:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chart-area"></i> Fetch Patterns';
            }
        }

        // Event Listeners
        document.getElementById('collectionSelect').addEventListener('change', loadData);
        document.getElementById('reloadBtn').addEventListener('click', loadData);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
        document.getElementById('applyPresetBtn').addEventListener('click', () => {
            const preset = document.getElementById('presetFilterSelect').value;
            applyPresetByName(preset);
        });
        document.getElementById('exportBtn').addEventListener('click', exportExcel);

        // Update action button listeners
        document.getElementById('updateTradingViewBtn').addEventListener('click', updateTradingView);
        document.getElementById('updateBarchartDailyBtn').addEventListener('click', updateBarchartDaily);
        document.getElementById('updateBarchartIntradayBtn').addEventListener('click', updateBarchartIntraday);
        document.getElementById('updateScoringBtn').addEventListener('click', updateScoring);
        document.getElementById('updateFuturesBtn').addEventListener('click', updateFutures);
        document.getElementById('fetchPatternsBtn').addEventListener('click', fetchPatterns);

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadData(); // This will call updateCounts() internally
        });
    </script>
</body>
</html>

