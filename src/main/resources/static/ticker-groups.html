<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticker Groups - MySwan</title>

    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --border-color: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success-color: #22c55e;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header - Ultra Compact */
        .header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 0.25rem 0.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        .logo h1 {
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-links a:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
        }

        .nav-links a.active {
            background: var(--primary-color);
            color: white;
        }

        /* Container - Full Width */
        .container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0.25rem 0.5rem;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 0.5rem;
            background: var(--card-bg);
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .page-header h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 0.65rem;
        }

        /* Table Container */
        .table-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            padding: 0.75rem;
        }

        /* Tabulator Dark Theme - Exact Same as Stock Grid */
        .tabulator {
            background: #1a1f2e !important;
            border: 2px solid #3b4252;
            font-size: 9px;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .tabulator-tableholder {
            background: #1a1f2e !important;
        }

        .tabulator-table {
            background: #1a1f2e !important;
        }

        .tabulator-header {
            background: linear-gradient(180deg, #3b4860 0%, #2e3440 100%);
            border-bottom: 4px solid #81a1c1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .tabulator-col {
            background: rgba(129, 161, 193, 0.15);
            border-right: 2px solid #5e81ac;
            vertical-align: top;
        }

        .tabulator-col:hover {
            background: rgba(129, 161, 193, 0.25);
        }

        .tabulator-col-title {
            color: #ffd700 !important;
            font-weight: 700;
            padding: 6px 4px;
            font-size: 9px;
            letter-spacing: 0.2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
            white-space: normal !important;
            word-wrap: break-word !important;
            line-height: 1.2;
        }

        .tabulator-col-title-holder {
            color: #ffd700 !important;
        }

        .tabulator-header .tabulator-col .tabulator-col-content .tabulator-col-title {
            color: #ffd700 !important;
            background: rgba(30, 41, 59, 0.6);
            padding: 3px 4px;
            border-radius: 4px;
            font-size: 9px;
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }

        .tabulator-col-title,
        .tabulator-col-title *,
        .tabulator-header .tabulator-col-title-holder,
        .tabulator-header .tabulator-col-content {
            color: #ffd700 !important;
        }

        .tabulator-col.tabulator-sortable:hover {
            background: rgba(129, 161, 193, 0.2);
        }

        .tabulator-col.tabulator-sortable .tabulator-col-title {
            padding-right: 25px;
        }

        .tabulator-arrow {
            border-bottom: 6px solid #88c0d0;
            border-top: 6px solid #88c0d0;
        }

        .tabulator-header-filter input {
            background: #141821;
            border: 2px solid #5e81ac;
            color: #ffffff;
            padding: 3px 4px;
            font-size: 9px;
            font-weight: 600;
            border-radius: 4px;
        }

        .tabulator-header-filter input:focus {
            border-color: #88c0d0;
            outline: none;
            background: #1a1f2e;
            box-shadow: 0 0 8px rgba(136, 192, 208, 0.4);
        }

        .tabulator-header-filter input::placeholder {
            color: #8fbcbb;
            font-weight: 500;
        }

        .tabulator-row {
            background: #242933 !important;
            border-bottom: 1px solid #3b4252;
            min-height: 28px;
        }

        .tabulator-row:nth-child(even) {
            background: #2a303c !important;
        }

        .tabulator-row:nth-child(odd) {
            background: #242933 !important;
        }

        .tabulator-row:hover {
            background: #3d4758 !important;
        }

        .tabulator-row.tabulator-selected {
            background: #4c5a73 !important;
        }

        .tabulator-row.tabulator-row-even {
            background: #2a303c !important;
        }

        .tabulator-row.tabulator-row-odd {
            background: #242933 !important;
        }

        .tabulator-row[role="row"] {
            background: #242933 !important;
        }

        .tabulator-row[role="row"]:nth-child(even) {
            background: #2a303c !important;
        }

        .tabulator-cell {
            color: #e5e9f0 !important;
            background: transparent !important;
            border-right: 1px solid #3b4252;
            padding: 6px 4px;
            line-height: 1.3;
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            font-size: 9px;
        }

        .tabulator-cell[tabulator-field] {
            background: transparent !important;
        }

        .tabulator-cell a {
            color: #81a1c1 !important;
            font-weight: 600;
            text-decoration: none;
        }

        .tabulator-cell a:hover {
            color: #88c0d0 !important;
            text-decoration: underline;
            text-shadow: 0 0 8px rgba(136, 192, 208, 0.5);
        }

        .tabulator-footer {
            background: #2e3440;
            border-top: 2px solid #4c566a;
            color: #d8dee9;
            padding: 10px;
        }

        .tabulator-page {
            background: rgba(94, 129, 172, 0.2);
            color: #88c0d0;
            border: 2px solid #5e81ac;
            margin: 0 4px;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 13px;
        }

        .tabulator-page:hover {
            background: rgba(94, 129, 172, 0.4);
            color: #8fbcbb;
        }

        .tabulator-page.active {
            background: #5e81ac;
            color: #eceff4;
            border-color: #81a1c1;
        }

        /* Positive/Negative values */
        .positive {
            color: var(--success-color);
        }

        .negative {
            color: var(--danger-color);
        }

        /* Ticker Badge */
        .ticker-badge {
            display: inline-block;
            background: rgba(30, 41, 59, 0.6);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 9px;
        }


        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>MySwan - Ticker Groups</h1>
            </div>
            <nav class="nav-links">
                <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="index.html"><i class="fas fa-table"></i> Classic View</a>
                <a href="patterns.html"><i class="fas fa-chart-bar"></i> Patterns</a>
                <a href="picks.html"><i class="fas fa-star"></i> Picks</a>
                <a href="watchlist.html"><i class="fas fa-eye"></i> Watchlist</a>
                <a href="ticker-groups.html" class="active"><i class="fas fa-object-group"></i> Ticker Groups</a>
                <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h2>Ticker Groups & Related ETFs</h2>
            <p>Total Rows: <span id="totalRows">-</span> | Last Updated: <span id="lastUpdated">-</span></p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading ticker groups...</p>
        </div>

        <!-- Table Container -->
        <div class="table-container" id="tableContainer" style="display: none;">
            <div id="ticker-groups-table"></div>
        </div>
    </div>

    <!-- Tabulator JS -->
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

    <script>
        let table;
        const API_BASE_URL = window.location.protocol + '//' + window.location.hostname + ':8070';

        // Format number with 2 decimals
        function formatNumber(value) {
            if (value === null || value === undefined || value === 0) return '-';
            return parseFloat(value).toFixed(2);
        }

        // Format change with color
        function formatChange(value) {
            if (value === null || value === undefined || value === 0) return '-';
            const formatted = parseFloat(value).toFixed(2);
            const className = value >= 0 ? 'positive' : 'negative';
            const sign = value >= 0 ? '+' : '';
            return `<span class="${className}">${sign}${formatted}</span>`;
        }

        // Format ticker badge
        function formatTickerBadge(ticker, type, isMain) {
            let color = '#fff'; // Default white for ETF
            if (isMain) {
                color = '#59eb25'; // Green for main ticker
            }
            return `<span class="ticker-badge" style="color: ${color}; font-weight: 700;">${ticker}</span>`;
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stock/grouped-tickers`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                let data = await response.json();
                console.log('Loaded ticker group rows:', data.length);

                // Sort by price difference (smallest difference first)
                data = data.sort((a, b) => {
                    const aMainPrice = a.mainPrice || 0;
                    const aEtfPrice = (a.relatedTickers && a.relatedTickers[0]) ? a.relatedTickers[0].price || 0 : 0;
                    const bMainPrice = b.mainPrice || 0;
                    const bEtfPrice = (b.relatedTickers && b.relatedTickers[0]) ? b.relatedTickers[0].price || 0 : 0;

                    const aDiff = Math.abs(aMainPrice - aEtfPrice);
                    const bDiff = Math.abs(bMainPrice - bEtfPrice);

                    return aDiff - bDiff; // Ascending order (smallest difference first)
                });

                console.log('Sorted by price difference (closest prices first)');

                // Update stats inline
                document.getElementById('totalRows').textContent = data.length;
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

                // Hide loading, show table
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';

                // Initialize table
                initTable(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <p style="color: var(--danger-color);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading data: ${error.message}
                    </p>
                `;
            }
        }

        // Initialize Tabulator table
        function initTable(data) {
            table = new Tabulator("#ticker-groups-table", {
                data: data,
                layout: "fitDataFill",
                height: "calc(100vh - 150px)",
                responsiveLayout: "collapse",
                placeholder: "No ticker groups found",
                pagination: "local",
                paginationSize: 100,
                paginationSizeSelector: [50, 100, 200, 500],
                columns: [
                    {
                        title: "Main Ticker",
                        field: "mainTicker",
                        width: 100,
                        headerFilter: "input",
                        formatter: (cell) => {
                            const data = cell.getRow().getData();
                            return formatTickerBadge(data.mainTicker, data.mainType, true);
                        }
                    },
                    {
                        title: "ETF Ticker",
                        field: "relatedTickers",
                        width: 100,
                        headerFilter: "input",
                        headerFilterFunc: (headerValue, rowValue) => {
                            if (!headerValue) return true;
                            if (!rowValue || rowValue.length === 0) return false;
                            const ticker = (rowValue[0].ticker || '').toString().toLowerCase();
                            return ticker.includes(headerValue.toLowerCase());
                        },
                        formatter: (cell) => {
                            const related = cell.getValue();
                            if (!related || related.length === 0) return '-';
                            const ticker = related[0].ticker;
                            const type = related[0].type;
                            return formatTickerBadge(ticker, type, false);
                        }
                    },
                    {
                        title: "Main Price",
                        field: "mainPrice",
                        width: 100,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">50",
                        formatter: (cell) => {
                            const value = cell.getValue();
                            return value ? `$${formatNumber(value)}` : '-';
                        }
                    },
                    {
                        title: "ETF Price",
                        field: "relatedTickers",
                        width: 100,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">50",
                        formatter: (cell) => {
                            const related = cell.getValue();
                            if (!related || related.length === 0) return '-';
                            const value = related[0].price;
                            return value ? `$${formatNumber(value)}` : '-';
                        }
                    },
                    {
                        title: "Price Diff",
                        field: "mainPrice",
                        width: 100,
                        headerFilter: "input",
                        headerFilterPlaceholder: "<1",
                        sorter: (a, b, aRow, bRow, column, dir, sorterParams) => {
                            const aData = aRow.getData();
                            const bData = bRow.getData();

                            const aMainPrice = aData.mainPrice || 0;
                            const aEtfPrice = (aData.relatedTickers && aData.relatedTickers[0]) ? aData.relatedTickers[0].price || 0 : 0;
                            const aDiff = Math.abs(aMainPrice - aEtfPrice);

                            const bMainPrice = bData.mainPrice || 0;
                            const bEtfPrice = (bData.relatedTickers && bData.relatedTickers[0]) ? bData.relatedTickers[0].price || 0 : 0;
                            const bDiff = Math.abs(bMainPrice - bEtfPrice);

                            return aDiff - bDiff;
                        },
                        formatter: (cell) => {
                            const data = cell.getRow().getData();
                            const mainPrice = data.mainPrice || 0;
                            const etfPrice = (data.relatedTickers && data.relatedTickers[0]) ? data.relatedTickers[0].price || 0 : 0;
                            const diff = Math.abs(mainPrice - etfPrice);
                            return `$${formatNumber(diff)}`;
                        }
                    },

                    //{
                    //    title: "Main Type",
                    //    field: "mainType",
                    //    width: 80,
                    //    headerFilter: "input",
                     //   headerFilterPlaceholder: "STOCK/ETF"
                    //},

                    //{
                     //   title: "ETF Type",
                      //  field: "relatedTickers",
                       // width: 80,
                        //headerFilter: "input",
                        //headerFilterPlaceholder: "ETF/DR",
                        //headerFilterFunc: (headerValue, rowValue, rowData, filterParams) => {
                         //   if (!headerValue) return true;
                          //  if (!rowValue || rowValue.length === 0) return false;
                           // const type = rowValue[0].type || '';
                            //return type.toLowerCase().includes(headerValue.toLowerCase());
                        //},
                        //formatter: (cell) => {
                         //   const related = cell.getValue();
                          //  if (!related || related.length === 0) return '-';
                           // return related[0].type || '-';
                        //}
                    //},
                    {
                        title: "Long/Short",
                        field: "relatedTickers",
                        width: 100,
                        headerFilter: "input",
                        headerFilterPlaceholder: "Long/Short",
                        headerFilterFunc: (headerValue, rowValue, rowData, filterParams) => {
                            if (!headerValue) return true;
                            if (!rowValue || rowValue.length === 0) return false;
                            const leverageType = rowValue[0].leverageType || 'Long';
                            return leverageType.toLowerCase().includes(headerValue.toLowerCase());
                        },
                        formatter: (cell) => {
                            const related = cell.getValue();
                            if (!related || related.length === 0) return '-';
                            const leverageType = related[0].leverageType || 'Long';
                            const className = leverageType === 'Short' ? 'negative' : 'positive';
                            return `<span class="${className}" style="font-weight: 600;">${leverageType}</span>`;
                        }
                    },
                    {
                        title: "Main Ticker Description",
                        field: "mainName",
                        minWidth: 250,
                        headerFilter: "input"
                    },
                    {
                        title: "ETF Description",
                        field: "relatedTickers",
                        minWidth: 250,
                        headerFilter: "input",
                        formatter: (cell) => {
                            const related = cell.getValue();
                            if (!related || related.length === 0) return '-';
                            return related[0].name || '-';
                        }
                    }
                ]
            });
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>
