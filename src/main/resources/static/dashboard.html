<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySwan Dashboard - Trading Analytics</title>

    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --border-color: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success-color: #22c55e;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header - Compact */
        .header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .nav-links a:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
        }

        .nav-links a.active {
            background: var(--primary-color);
            color: white;
        }

        /* Container - Full Width for Maximum Columns */
        .container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0.5rem;
        }

        /* Stats Cards - Compact */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .stat-icon.blue { background: rgba(37, 99, 235, 0.1); color: var(--primary-color); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--secondary-color); }
        .stat-icon.purple { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.15rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            padding: 0.15rem 0.35rem;
            border-radius: 4px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        /* Control Panel - Compact */
        .control-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .control-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .control-group label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .control-group select,
        .control-group input {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            transition: all 0.3s;
            min-width: 120px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Buttons - Compact */
        .btn {
            padding: 0.4rem 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
            border-color: var(--text-primary);
        }

        /* Data Grid - Compact */
        .data-grid {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .grid-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .grid-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Enhanced text visibility */
        #dataTable {
            font-family: 'Segoe UI', 'Roboto', system-ui, sans-serif;
        }

        /* Make specific data more visible */
        .tabulator-cell[tabulator-field="ticker"] {
            font-weight: 700;
            font-size: 13px;
        }

        .tabulator-cell[tabulator-field="change"] {
            font-weight: 700;
            font-size: 13px;
        }

        .tabulator-cell[tabulator-field="price"] {
            font-weight: 700;
            font-size: 13px;
        }

        /* Signal badges - more visible */
        .tabulator-cell span[style*="BUY"],
        .tabulator-cell span[style*="SELL"] {
            padding: 4px 10px !important;
            font-size: 11px !important;
            font-weight: 700 !important;
            border-radius: 6px !important;
            letter-spacing: 0.5px;
        }

        /* Tabulator Dark Theme - Smaller Font, Wrapped Headers */
        .tabulator {
            background: #1a1f2e !important;
            border: 2px solid #3b4252;
            font-size: 9px;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        /* Force dark background for table body */
        .tabulator-tableholder {
            background: #1a1f2e !important;
        }

        .tabulator-table {
            background: #1a1f2e !important;
        }

        .tabulator-header {
            background: linear-gradient(180deg, #3b4860 0%, #2e3440 100%);
            border-bottom: 4px solid #81a1c1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .tabulator-col {
            background: rgba(129, 161, 193, 0.15);
            border-right: 2px solid #5e81ac;
            vertical-align: top;
        }

        .tabulator-col:hover {
            background: rgba(129, 161, 193, 0.25);
        }

        .tabulator-col-title {
            color: #ffd700 !important;
            font-weight: 700;
            padding: 6px 4px;
            font-size: 9px;
            letter-spacing: 0.2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
            white-space: normal !important;
            word-wrap: break-word !important;
            line-height: 1.2;
        }

        .tabulator-col-title-holder {
            color: #ffd700 !important;
        }

        /* Make header text super visible with bright yellow color and wrap text */
        .tabulator-header .tabulator-col .tabulator-col-content .tabulator-col-title {
            color: #ffd700 !important;
            background: rgba(30, 41, 59, 0.6);
            padding: 3px 4px;
            border-radius: 4px;
            font-size: 9px;
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }

        /* Force bright color on all header text elements */
        .tabulator-col-title,
        .tabulator-col-title *,
        .tabulator-header .tabulator-col-title-holder,
        .tabulator-header .tabulator-col-content {
            color: #ffd700 !important;
        }

        /* Sortable column hover */
        .tabulator-col.tabulator-sortable:hover {
            background: rgba(129, 161, 193, 0.2);
        }

        .tabulator-col.tabulator-sortable .tabulator-col-title {
            padding-right: 25px;
        }

        /* Sort arrows more visible */
        .tabulator-arrow {
            border-bottom: 6px solid #88c0d0;
            border-top: 6px solid #88c0d0;
        }

        .tabulator-header-filter input {
            background: #141821;
            border: 2px solid #5e81ac;
            color: #ffffff;
            padding: 3px 4px;
            font-size: 9px;
            font-weight: 600;
            border-radius: 4px;
        }

        .tabulator-header-filter input:focus {
            border-color: #88c0d0;
            outline: none;
            background: #1a1f2e;
            box-shadow: 0 0 8px rgba(136, 192, 208, 0.4);
        }

        .tabulator-header-filter input::placeholder {
            color: #8fbcbb;
            font-weight: 500;
        }

        .tabulator-row {
            background: #242933 !important;
            border-bottom: 1px solid #3b4252;
            min-height: 28px;
        }

        .tabulator-row:nth-child(even) {
            background: #2a303c !important;
        }

        .tabulator-row:nth-child(odd) {
            background: #242933 !important;
        }

        .tabulator-row:hover {
            background: #3d4758 !important;
        }

        .tabulator-row.tabulator-selected {
            background: #4c5a73 !important;
        }

        /* Force dark background during all interactions */
        .tabulator-row.tabulator-row-even {
            background: #2a303c !important;
        }

        .tabulator-row.tabulator-row-odd {
            background: #242933 !important;
        }

        /* Prevent white backgrounds during virtual DOM updates */
        .tabulator-row[role="row"] {
            background: #242933 !important;
        }

        .tabulator-row[role="row"]:nth-child(even) {
            background: #2a303c !important;
        }

        .tabulator-cell {
            color: #e5e9f0 !important;
            background: transparent !important;
            border-right: 1px solid #3b4252;
            padding: 6px 4px;
            line-height: 1.3;
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            font-size: 9px;
        }

        /* Prevent cell backgrounds from turning white */
        .tabulator-cell[tabulator-field] {
            background: transparent !important;
        }

        /* Enhanced link visibility */
        .tabulator-cell a {
            color: #81a1c1 !important;
            font-weight: 600;
            text-decoration: none;
        }

        .tabulator-cell a:hover {
            color: #88c0d0 !important;
            text-decoration: underline;
            text-shadow: 0 0 8px rgba(136, 192, 208, 0.5);
        }

        /* Number cells - better readability */
        .tabulator-cell[tabulator-field*="score"],
        .tabulator-cell[tabulator-field*="Score"],
        .tabulator-cell[tabulator-field*="price"],
        .tabulator-cell[tabulator-field*="Price"] {
            font-weight: 600;
            color: #d8dee9;
        }

        .tabulator-footer {
            background: #2e3440;
            border-top: 2px solid #4c566a;
            color: #d8dee9;
            padding: 10px;
        }

        .tabulator-page {
            background: rgba(94, 129, 172, 0.2);
            color: #88c0d0;
            border: 2px solid #5e81ac;
            margin: 0 4px;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 13px;
        }

        .tabulator-page:hover {
            background: rgba(94, 129, 172, 0.4);
            color: #8fbcbb;
        }

        .tabulator-page.active {
            background: #5e81ac;
            color: #eceff4;
            border-color: #81a1c1;
        }

        /* Scrollbar - much more visible */
        .tabulator::-webkit-scrollbar {
            height: 14px;
            width: 14px;
        }

        .tabulator::-webkit-scrollbar-track {
            background: #1a1f2e;
            border: 1px solid #3b4252;
        }

        .tabulator::-webkit-scrollbar-thumb {
            background: #4c566a;
            border-radius: 7px;
            border: 2px solid #1a1f2e;
        }

        .tabulator::-webkit-scrollbar-thumb:hover {
            background: #5e81ac;
        }

        .tabulator::-webkit-scrollbar-corner {
            background: #1a1f2e;
        }

        /* Make empty cells visible */
        .tabulator-cell:empty:after {
            content: '-';
            color: #6c7a8e;
            font-weight: 400;
        }

        /* Tooltip Styling - Dark with Bright Gold Text */
        .tabulator-tooltip {
            background: #1a1f2e !important;
            border: 2px solid #5e81ac !important;
            color: #ffd700 !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            padding: 8px 12px !important;
            border-radius: 6px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
            max-width: 400px !important;
            word-wrap: break-word !important;
        }

        /* Info Panel - Compact */
        .info-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(37, 99, 235, 0.05);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .info-text {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .info-text i {
            color: var(--primary-color);
            font-size: 0.75rem;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(37, 99, 235, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group select,
            .control-group input {
                min-width: 100%;
            }

            .nav-links {
                display: none;
            }
        }

        /* Preset Filter Badge - Compact */
        .preset-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 6px;
            font-size: 0.75rem;
            color: #a78bfa;
        }

        .preset-badge i {
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>MySwan Trading Dashboard</h1>
            </div>
            <nav class="nav-links">
                <a href="index.html" class="active"><i class="fas fa-home"></i> Dashboard</a>
                <a href="classic.html"><i class="fas fa-table"></i> Classic View</a>
                <a href="futures.html"><i class="fas fa-money-bill-trend"></i> Futures</a>
                <a href="discover.html"><i class="fas fa-search"></i> Discover</a>
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card" onclick="selectCollection('stocks')">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="stockCount">-</div>
                        <div class="stat-label">Total Stocks</div>
                    </div>
                    <div class="stat-icon blue">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> Active Trading
                </div>
            </div>

            <div class="stat-card" onclick="selectCollection('masters')">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="masterCount">-</div>
                        <div class="stat-label">Master Symbols</div>
                    </div>
                    <div class="stat-icon green">
                        <i class="fas fa-database"></i>
                    </div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-check-circle"></i> Watchlist Ready
                </div>
            </div>

            <div class="stat-card" onclick="selectCollection('futures')">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="futuresCount">-</div>
                        <div class="stat-label">Futures Contracts</div>
                    </div>
                    <div class="stat-icon purple">
                        <i class="fas fa-money-bill-trend"></i>
                    </div>
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-trend-up"></i> Live Markets
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="filteredCount">-</div>
                        <div class="stat-label">Filtered Results</div>
                    </div>
                    <div class="stat-icon orange">
                        <i class="fas fa-filter"></i>
                    </div>
                </div>
                <div class="stat-change" id="filterStatus">
                    <i class="fas fa-info-circle"></i> No filters applied
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-header">
                <h2>
                    <i class="fas fa-sliders"></i>
                    Data Controls
                </h2>
                <div id="activePreset" style="display: none;" class="preset-badge">
                    <i class="fas fa-magic"></i>
                    <span id="presetName">No Preset</span>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Collection</label>
                    <select id="collectionSelect">
                        <option value="masters">Master Symbols</option>
                        <option value="stocks" selected>Stocks</option>
                        <option value="futures">Futures</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Preset Filters</label>
                    <select id="presetFilterSelect">
                        <option value="none">-- No Preset --</option>
                        <option value="explosive">ðŸš€ EXPLOSIVE 4-7 DAY</option>
                        <option value="filter2">ðŸ’Ž High Value Stocks</option>
                        <option value="filter3">ðŸ“ˆ Momentum Leaders</option>
                        <option value="filter4">ðŸŽ¯ Breakout Candidates</option>
                        <option value="filter5">âš¡ Quick Gains</option>
                        <option value="filter6">ðŸ”¥ Hot Picks</option>
                        <option value="filter7">ðŸ’° Value Plays</option>
                        <option value="filter8">ðŸŒŸ Top Rated</option>
                    </select>
                </div>

                <button class="btn btn-success" id="applyPresetBtn">
                    <i class="fas fa-magic"></i> Apply Preset
                </button>

                <button class="btn btn-primary" id="reloadBtn">
                    <i class="fas fa-sync"></i> Reload Data
                </button>

                <button class="btn btn-secondary" id="clearFiltersBtn">
                    <i class="fas fa-times"></i> Clear Filters
                </button>

                <button class="btn btn-secondary" id="exportBtn">
                    <i class="fas fa-download"></i> Export Excel
                </button>
            </div>
        </div>

        <!-- Data Grid -->
        <div class="data-grid">
            <div class="grid-header">
                <h2>
                    <i class="fas fa-table"></i>
                    <span id="gridTitle">Stock Data</span>
                </h2>
                <div class="grid-actions">
                    <button class="btn btn-secondary" onclick="table.clearHeaderFilter()">
                        <i class="fas fa-eraser"></i> Clear Header Filters
                    </button>
                </div>
            </div>

            <div id="dataTable"></div>

            <div class="info-panel">
                <div class="info-text">
                    <i class="fas fa-info-circle"></i>
                    <span id="gridInfo">Loading data...</span>
                </div>
                <div class="info-text">
                    <i class="fas fa-calendar"></i>
                    <span id="lastUpdate">Last update: Never</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/[email protected]/dist/chart.umd.js"></script>

    <script>
        const API_BASE = "http://jpmaxtricks.com:8070/api";

        let table;
        let currentCollection = "stocks";
        let loadedTotal = 0;
        let filteredTotal = 0;
        let activePresetFn = null;

        // Helper functions from original index.html
        function getNested(row, path) {
            if (!row || !path) return null;
            const parts = path.split('.');
            let cur = row;
            for (const p of parts) {
                if (cur == null) return null;
                cur = cur[p];
            }
            return cur;
        }

        function numericHeaderFilter(headerValue, rowValue, rowData, filterParams){
            if(headerValue === null || headerValue === undefined) return true;
            const s = String(headerValue).trim();
            if(s === '') return true;
            const opMatch = s.match(/^([><]=?)\s*(-?\d+(?:\.\d+)?)$/);
            let rv = Number(rowValue);
            if(isNaN(rv)) rv = null;
            if(opMatch){
                const op = opMatch[1];
                const num = parseFloat(opMatch[2]);
                if(rv === null) return false;
                switch(op){
                    case '>': return rv > num;
                    case '>=': return rv >= num;
                    case '<': return rv < num;
                    case '<=': return rv <= num;
                }
            }
            const rangeMatch = s.match(/^(-?\d+(?:\.\d+)?)\s*-\s*(-?\d+(?:\.\d+)?)$/);
            if(rangeMatch){
                const low = parseFloat(rangeMatch[1]);
                const high = parseFloat(rangeMatch[2]);
                if(rv === null) return false;
                return rv >= Math.min(low, high) && rv <= Math.max(low, high);
            }
            const numMatch = s.match(/^-?\d+(?:\.\d+)?$/);
            if(numMatch){
                const num = parseFloat(numMatch[0]);
                if(rv === null) return false;
                return rv === num;
            }
            if(rowValue === null || rowValue === undefined) return false;
            return String(rowValue).toLowerCase().indexOf(s.toLowerCase()) !== -1;
        }

        // Column definitions (complete from index.html)
        const columnsMaster = [
            {title: "Ticker", field: "ticker", headerFilter: "input", width: 80},
            {title: "Name", field: "name", headerFilter: "input", width: 200},
            {title: "Type", field: "type", headerFilter: "input", width: 70},
            {title: "Added Price", field: "addedPrice", headerFilter: "input", width: 90},
            {title: "Added Date", field: "addedDate", headerFilter: "input", width: 100}
        ];

        const columnsStock = [
            {title: "Ticker", field: "ticker", headerFilter: "input", width: 70, formatter:function(cell){ const v = cell.getValue(); if(!v) return ""; return `<a href="stock-history.html?ticker=${encodeURIComponent(v)}" target="_blank" style="color: #3b82f6; text-decoration: none;">${v}</a>`; }},
            {title: "Chg", field: "change", headerFilter: "input", headerFilterPlaceholder: ">0", headerFilterFunc: numericHeaderFilter, width: 70, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #22c55e;">â–² ${val.toFixed(2)}</span>`; if (val < 0) return `<span style="color: #ef4444;">â–¼ ${val.toFixed(2)}</span>`; return val; }},
            {title: "Low", field: "low", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 70},
            {title: "Price", field: "price", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 70},
            {title: "High", field: "high", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 70},
            {title: "Bottom", field: "bottom.bottom", headerFilter: "input", width: 70, hozAlign: "center", formatter: function(cell){ const v = cell.getValue(); return (v === true || v === 'true') ? "âœ…" : ""; }},
            {title: "BotMet", field: "bottom.conditionsMet", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 70, hozAlign: "center"},
            {title: "BotStr", field: "bottom.strength", headerFilter: "input", width: 80, hozAlign: "center"},
            {title: "SpkLikely", field: "spike.spikeLikely", headerFilter: "input", width: 80, hozAlign: "center"},
            {title: "SpkScore", field: "spike.spikeScore", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80, hozAlign: "center"},
            {title: "SpkType", field: "spike.spikeType", headerFilter: "input", width: 80, hozAlign: "center"},
            {title: "Signal", field: "score.signal", headerFilter: "input", width: 70, formatter: function(cell) { const val = cell.getValue(); if (val === 'BUY') return `<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; if (val === 'SELL') return `<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; return val; }},
            {title: "Overall", field: "score.overallScore", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 70},
            {title: "DT", field: "score.dayTradingScore", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 60},
            {title: "ST", field: "score.swingTradingScore", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 60},
            {title: "Revsl", field: "score.reversalScore", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 65},
            {title: "Brkout", field: "score.breakoutScore", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 70},
            {title: "Patrn", field: "score.patternScore", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 65},
            {title: "BTShort", field: "rating.btShortRating", headerFilter: "input", width: 80},
            {title: "BTLong", field: "rating.btLongRating", headerFilter: "input", width: 80},
            {title: "BT", field: "rating.btRating", headerFilter: "input", width: 80},
            {title: "BTTrend", field: "rating.btTrend", headerFilter: "input", width: 80},
            {title: "TVMA", field: "rating.tradingViewMARating", headerFilter: "input", width: 80},
            {title: "TVTech", field: "rating.tradingViewTechRating", headerFilter: "input", width: 80},
            {title: "TVAnaly", field: "rating.tradingViewAnalystsRating", headerFilter: "input", width: 80},
            {title: "BotReasons", field: "bottom.reasons", headerFilter: "input", width: 150, formatter: function(cell){ const v = cell.getValue(); if (!v) return ""; if (Array.isArray(v)) return v.join(', '); return v; }},
            {title: "SpkReasons", field: "spike.reasons", headerFilter: "input", width: 150, formatter: function(cell){ const v = cell.getValue(); if (!v) return ""; if (Array.isArray(v)) return v.join(', '); return v; }},
            {title: "DTR", field: "score.dayTradingReason", headerFilter: "input", width: 120},
            {title: "STR", field: "score.swingTradingReason", headerFilter: "input", width: 120},
            {title: "RevR", field: "score.reversalReason", headerFilter: "input", width: 120},
            {title: "BrkR", field: "score.breakoutReason", headerFilter: "input", width: 120},
            {title: "PatR", field: "score.patternReason", headerFilter: "input", width: 120},
        ];

        const columnsFutures = [
            {title: "Ticker", field: "ticker", headerFilter: "input", width: 90, formatter:function(cell){ const v = cell.getValue(); if(!v) return ""; return `<a href="futures-history.html?ticker=${encodeURIComponent(v)}" target="_blank" style="color: #3b82f6; text-decoration: none;">${v}</a>`; }},
            {title: "Type", field: "type", headerFilter: "input", width: 70},
            {title: "Price", field: "price", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "Change", field: "change", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80, formatter: function(cell) { const val = cell.getValue(); if (val > 0) return `<span style="color: #22c55e;">â–² ${val.toFixed(2)}</span>`; if (val < 0) return `<span style="color: #ef4444;">â–¼ ${val.toFixed(2)}</span>`; return val; }},
            {title: "Open", field: "open", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "High", field: "high", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "Low", field: "low", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "Volume", field: "volume", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 100},
            {title: "OpenInt", field: "openInterest", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 90},
            {title: "ExpDate", field: "expiryDate", headerFilter: "input", width: 100},
            {title: "ExpDays", field: "expiryDays", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "PrevClose", field: "prevClose", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 90},
            {title: "UpHigh", field: "upHigh", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "DnLow", field: "downLow", headerFilter: "input", headerFilterFunc: numericHeaderFilter, width: 80},
            {title: "BTShort", field: "rating.btShortRating", headerFilter: "input", width: 80},
            {title: "BTLong", field: "rating.btLongRating", headerFilter: "input", width: 80},
            {title: "BT", field: "rating.btRating", headerFilter: "input", width: 80},
            {title: "BTTrend", field: "rating.btTrend", headerFilter: "input", width: 80},
            {title: "HistDate", field: "histDate", headerFilter: "input", width: 100},
        ];

        // Preset filter functions
        function filterExplosive(row) {
            const spikeScore = Number(getNested(row, 'spike.spikeScore')) || 0;
            const bottomConds = Number(getNested(row, 'bottom.conditionsMet')) || 0;
            const breakoutScore = Number(getNested(row, 'score.breakoutScore')) || 0;
            const overallScore = Number(getNested(row, 'score.overallScore')) || 0;
            const signal = (getNested(row, 'score.signal') || '').toString().toUpperCase();
            return spikeScore >= 70 && bottomConds >= 5 && breakoutScore >= 60 && overallScore >= 65 && signal === 'BUY';
        }

        function filterPreset2(row) { return false; }
        function filterPreset3(row) { return false; }
        function filterPreset4(row) { return false; }
        function filterPreset5(row) { return false; }
        function filterPreset6(row) { return false; }
        function filterPreset7(row) { return false; }
        function filterPreset8(row) { return false; }

        function applyPresetByName(name) {
            clearActivePreset();
            if (!table || name === 'none') {
                document.getElementById('activePreset').style.display = 'none';
                return;
            }

            let fn, displayName;
            switch (name) {
                case 'explosive': fn = filterExplosive; displayName = 'EXPLOSIVE 4-7 DAY'; break;
                case 'filter2': fn = filterPreset2; displayName = 'High Value Stocks'; break;
                case 'filter3': fn = filterPreset3; displayName = 'Momentum Leaders'; break;
                case 'filter4': fn = filterPreset4; displayName = 'Breakout Candidates'; break;
                case 'filter5': fn = filterPreset5; displayName = 'Quick Gains'; break;
                case 'filter6': fn = filterPreset6; displayName = 'Hot Picks'; break;
                case 'filter7': fn = filterPreset7; displayName = 'Value Plays'; break;
                case 'filter8': fn = filterPreset8; displayName = 'Top Rated'; break;
                default: fn = null;
            }

            if (fn) {
                try {
                    table.addFilter(fn);
                    activePresetFn = fn;
                    document.getElementById('activePreset').style.display = 'flex';
                    document.getElementById('presetName').textContent = displayName;
                    document.getElementById('filterStatus').innerHTML = '<i class="fas fa-filter"></i> Preset filter active';
                    document.getElementById('filterStatus').className = 'stat-change positive';
                    try { filteredTotal = table.getData(true).length; } catch (e) { }
                    updateGridInfo();
                } catch (e) {
                    console.error('Failed to apply preset filter', e);
                }
            }
        }

        function clearActivePreset() {
            if (!table) return;
            if (activePresetFn) {
                try { table.removeFilter(activePresetFn); } catch (e) { }
                activePresetFn = null;
                document.getElementById('activePreset').style.display = 'none';
                document.getElementById('filterStatus').innerHTML = '<i class="fas fa-info-circle"></i> No filters applied';
                document.getElementById('filterStatus').className = 'stat-change';
                try { filteredTotal = table.getData(true).length; } catch (e) { filteredTotal = loadedTotal; }
                updateGridInfo();
            }
        }

        function createTable(columns) {
            if (table) {
                table.setColumns(columns);
                return;
            }

            table = new Tabulator("#dataTable", {
                layout: "fitData",
                height: "calc(100vh - 260px)",
                pagination: true,
                paginationSize: 100,
                paginationSizeSelector: [50, 100, 200, 500],
                columns: columns,
                placeholder: "No data available - Select a collection and click Reload",
                rowHeight: 28,
                headerFilterPlaceholder: "",
                columnDefaults: {
                    resizable: true,
                    headerSort: true,
                    tooltip: true,
                    minWidth: 70,
                    headerWordWrap: true,
                },
                virtualDomBuffer: 300,
                textSize: 9,
            });

            // Event handlers for filter tracking
            if (table && typeof table.on === 'function') {
                try {
                    table.on('dataFiltered', function(filters, rows){
                        try {
                            filteredTotal = Array.isArray(rows) ? rows.length : table.getData(true).length;
                        } catch (e) { }
                        updateGridInfo();
                    });
                } catch (e) { }
            }
        }

        async function loadData() {
            const collection = document.getElementById('collectionSelect').value;
            currentCollection = collection;

            let url, columns, title;
            if (collection === 'masters') {
                url = `${API_BASE}/master/list`;
                columns = columnsMaster;
                title = "Master Symbols";
            } else if (collection === 'stocks') {
                url = `${API_BASE}/stock/list`;
                columns = columnsStock;
                title = "Stock Data";
            } else if (collection === 'futures') {
                url = `${API_BASE}/futures/list`;
                columns = columnsFutures;
                title = "Futures Contracts";
            }

            console.log('=== Loading Data ===');
            console.log('Collection:', collection);
            console.log('URL:', url);
            console.log('API_BASE:', API_BASE);

            document.getElementById('gridTitle').textContent = title;

            // Always create table first
            try {
                createTable(columns);
                console.log('Table created/updated with columns');
            } catch (e) {
                console.error('Error creating table:', e);
            }

            try {
                console.log('Fetching from:', url);
                const response = await fetch(url);
                console.log('Response received - Status:', response.status, 'OK:', response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Data parsed - Type:', typeof data, 'IsArray:', Array.isArray(data));
                console.log('Data length:', Array.isArray(data) ? data.length : 'N/A');
                console.log('First item sample:', Array.isArray(data) && data.length > 0 ? data[0] : data);

                const rows = Array.isArray(data) ? data : (data ? [data] : []);
                console.log('Rows to display:', rows.length);

                loadedTotal = rows.length || 0;
                filteredTotal = loadedTotal;

                if (table) {
                    console.log('Replacing table data with', rows.length, 'rows...');
                    await table.replaceData(rows);
                    console.log('âœ“ Table data replaced successfully');
                } else {
                    console.error('Table not initialized!');
                }

                updateGridInfo();
                updateCounts();
                document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                console.log('=== Load Complete ===');
            } catch (err) {
                console.error('=== ERROR Loading Data ===');
                console.error('Error type:', err.name);
                console.error('Error message:', err.message);
                console.error('Error stack:', err.stack);
                console.error('URL was:', url);
                alert(`Failed to load data from ${collection}:\n${err.message}\n\nCheck browser console (F12) for details.`);

                // Try to show empty table
                if (table) {
                    try {
                        await table.replaceData([]);
                    } catch (e) {
                        console.error('Could not clear table:', e);
                    }
                }
            }
        }

        function updateGridInfo() {
            const info = document.getElementById('gridInfo');
            const filtered = document.getElementById('filteredCount');

            info.textContent = `Showing ${filteredTotal} of ${loadedTotal} records | Page ${table ? (table.getPage() || 1) : 1} of ${table ? (table.getPageMax() || 1) : 1}`;
            filtered.textContent = filteredTotal;
        }

        async function updateCounts() {
            console.log('Updating counts...');
            try {
                const [stocks, masters, futures] = await Promise.all([
                    fetch(`${API_BASE}/stock/list`).then(r => r.ok ? r.json() : []).catch(() => []),
                    fetch(`${API_BASE}/master/list`).then(r => r.ok ? r.json() : []).catch(() => []),
                    fetch(`${API_BASE}/futures/list`).then(r => r.ok ? r.json() : []).catch(() => [])
                ]);

                const stockCount = Array.isArray(stocks) ? stocks.length : 0;
                const masterCount = Array.isArray(masters) ? masters.length : 0;
                const futuresCount = Array.isArray(futures) ? futures.length : 0;

                document.getElementById('stockCount').textContent = stockCount;
                document.getElementById('masterCount').textContent = masterCount;
                document.getElementById('futuresCount').textContent = futuresCount;

                console.log('Counts updated - Stocks:', stockCount, 'Masters:', masterCount, 'Futures:', futuresCount);
            } catch (e) {
                console.error('Failed to update counts:', e);
                document.getElementById('stockCount').textContent = '?';
                document.getElementById('masterCount').textContent = '?';
                document.getElementById('futuresCount').textContent = '?';
            }
        }

        function selectCollection(coll) {
            document.getElementById('collectionSelect').value = coll;
            loadData();
        }

        function clearFilters() {
            if (table) {
                table.clearFilter(true);
                table.clearHeaderFilter();
                clearActivePreset();
                filteredTotal = loadedTotal;
                updateGridInfo();
            }
        }

        function exportExcel() {
            if (!table) return;
            const data = table.getData();
            if (!data.length) return alert('No data to export');

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, currentCollection);
            XLSX.writeFile(wb, `myswan-${currentCollection}-${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // Event Listeners
        document.getElementById('collectionSelect').addEventListener('change', loadData);
        document.getElementById('reloadBtn').addEventListener('click', loadData);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
        document.getElementById('applyPresetBtn').addEventListener('click', () => {
            const preset = document.getElementById('presetFilterSelect').value;
            applyPresetByName(preset);
        });
        document.getElementById('exportBtn').addEventListener('click', exportExcel);

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateCounts();
        });
    </script>
</body>
</html>

