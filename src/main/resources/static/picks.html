<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySwan - My Picks</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #3b82f6;
            font-size: 1.5rem;
        }

        .toolbar {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: #f1f5f9;
            border: 1px solid #475569;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.3);
        }

        .info {
            text-align: center;
            margin-top: 5px;
            color: #94a3b8;
            font-size: 11px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 8px;
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            font-size: 12px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Tabulator Dark Theme */
        .tabulator {
            background: #1e293b;
            border: 1px solid #334155;
            font-size: 11px;
        }

        .tabulator .tabulator-header {
            background: #0f172a;
            border-bottom: 2px solid #3b82f6;
        }

        .tabulator .tabulator-header .tabulator-col {
            background: #0f172a;
            color: #f1f5f9;
            border-right: 1px solid #334155;
            padding: 6px 4px;
            font-size: 11px;
        }

        .tabulator .tabulator-tableholder .tabulator-table {
            color: #f1f5f9;
        }

        .tabulator-row {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            min-height: 28px;
            color: #f1f5f9;
        }

        .tabulator-row.tabulator-row-even {
            background: #1a2332;
        }

        .tabulator-row.tabulator-row-odd {
            background: #1e293b;
        }

        .tabulator-row:hover {
            background: #334155 !important;
            color: #f1f5f9 !important;
        }

        .tabulator-row.tabulator-selected {
            background: #1e40af !important;
            color: #f1f5f9 !important;
        }

        .tabulator-cell {
            border-right: 1px solid #334155;
            padding: 4px 6px;
            font-size: 11px;
            color: #f1f5f9;
        }

        /* Cell editing styles */
        .tabulator .tabulator-cell.tabulator-editing {
            background: #0f172a !important;
            border: 2px solid #3b82f6 !important;
        }

        .tabulator .tabulator-cell.tabulator-editing input,
        .tabulator .tabulator-cell.tabulator-editing select {
            background: #0f172a;
            color: #f1f5f9;
            border: 1px solid #3b82f6;
            padding: 4px 8px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #1e293b;
            margin: 3% auto;
            padding: 20px;
            border: 1px solid #334155;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            color: #3b82f6;
            font-size: 1.3rem;
        }

        .close {
            color: #94a3b8;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #f1f5f9;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            color: #94a3b8;
            font-weight: 500;
            font-size: 12px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 6px 8px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #f1f5f9;
            font-size: 12px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .status-met {
            color: #10b981;
            font-weight: 600;
        }

        .status-not-met {
            color: #ef4444;
            font-weight: 600;
        }

        .ticker-link {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .ticker-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        <a href="ticker-groups.html" class="back-link" style="margin-left: 10px;"><i class="fas fa-object-group"></i> Ticker Groups</a>

        <h1><i class="fas fa-star"></i> My Picks</h1>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="openAddPickModal()">
                <i class="fas fa-plus"></i> Add Pick
            </button>
            <button class="btn btn-primary" onclick="syncPicksWithStock()">
                <i class="fas fa-refresh"></i> Sync Prices
            </button>
            <button class="btn btn-success" onclick="reloadPicks()">
                <i class="fas fa-sync"></i> Reload
            </button>
            <button class="btn btn-secondary" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
            <button class="btn btn-danger" onclick="deleteSelectedPicks()">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button class="btn btn-secondary" onclick="clearAllFilters()">
                <i class="fas fa-filter-circle-xmark"></i> Clear All Filters
            </button>
        </div>

        <!-- Slider Filters -->
        <div style="background: #094b92; padding: 8px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                <div style="padding: 2px; margin: 0;">
                    <label style="display: block; font-size: 10px; font-weight: 600; color: #ffffff; margin-bottom: 2px;">
                        Progress: <span id="progressValue" style="color: #fbbf24;">-100+</span>
                    </label>
                    <input type="range" id="progressSlider" min="-100" max="200" value="-100"
                           style="width: 80px; accent-color: #fbbf24;">
                </div>
                <div style="padding: 2px; margin: 0;">
                    <label style="display: block; font-size: 10px; font-weight: 600; color: #ffffff; margin-bottom: 2px;">
                        Pick: <span id="pickScoreValue" style="color: #fbbf24;">0+</span>
                    </label>
                    <input type="range" id="pickScoreSlider" min="0" max="100" value="0"
                           style="width: 80px; accent-color: #fbbf24;">
                </div>
                <div style="padding: 2px; margin: 0;">
                    <label style="display: block; font-size: 10px; font-weight: 600; color: #ffffff; margin-bottom: 2px;">
                        Rank: <span id="rankValue" style="color: #fbbf24;">0+</span>
                    </label>
                    <input type="range" id="rankSlider" min="0" max="100" value="0"
                           style="width: 80px; accent-color: #fbbf24;">
                </div>
                <div style="padding: 2px; margin: 0;">
                    <label style="display: block; font-size: 10px; font-weight: 600; color: #ffffff; margin-bottom: 2px;">
                        Safe: <span id="safeValue" style="color: #fbbf24;">0+</span>
                    </label>
                    <input type="range" id="safeSlider" min="0" max="100" value="0"
                           style="width: 80px; accent-color: #fbbf24;">
                </div>
                <div style="padding: 2px; margin: 0;">
                    <label style="display: block; font-size: 10px; font-weight: 600; color: #ffffff; margin-bottom: 2px;">
                        Spike: <span id="spikeScoreValue" style="color: #fbbf24;">0+</span>
                    </label>
                    <input type="range" id="spikeScoreSlider" min="0" max="100" value="0"
                           style="width: 80px; accent-color: #fbbf24;">
                </div>
                <div style="padding: 2px; margin: 0;">
                    <label style="display: block; font-size: 10px; font-weight: 600; color: #ffffff; margin-bottom: 2px;">
                        Long#: <span id="longPatternsValue" style="color: #fbbf24;">0+</span>
                    </label>
                    <input type="range" id="longPatternsSlider" min="0" max="10" value="0"
                           style="width: 80px; accent-color: #fbbf24;">
                </div>
                <div style="padding: 2px; margin: 0;">
                    <label style="display: block; font-size: 10px; font-weight: 600; color: #ffffff; margin-bottom: 2px;">
                        Short#: <span id="shortPatternsValue" style="color: #fbbf24;">0+</span>
                    </label>
                    <input type="range" id="shortPatternsSlider" min="0" max="10" value="0"
                           style="width: 80px; accent-color: #fbbf24;">
                </div>
                <div style="padding: 2px; margin: 0;">
                    <label style="display: block; font-size: 10px; font-weight: 600; color: #ffffff; margin-bottom: 2px;">
                        DaysLeft: <span id="daysLeftValue" style="color: #fbbf24;">&lt; 60</span>
                    </label>
                    <input type="range" id="daysLeftSlider" min="0" max="60" value="60"
                           style="width: 80px; accent-color: #fbbf24;">
                </div>
            </div>
        </div>

        <div id="picksTable"></div>
        <div class="info" id="info"></div>
    </div>

    <!-- Add/Edit Pick Modal -->
    <div id="pickModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Pick</h2>
                <span class="close" onclick="closePickModal()">&times;</span>
            </div>
            <form id="pickForm">
                <input type="hidden" id="pickId">

                <div class="form-group">
                    <label for="ticker">Ticker *</label>
                    <input type="text" id="ticker" required>
                </div>

                <div class="form-group">
                    <label for="reason">Reason *</label>
                    <textarea id="reason" required placeholder="Why is this a good pick?"></textarea>
                </div>

                <div class="form-group">
                    <label for="entry">Entry Price *</label>
                    <input type="number" id="entry" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="target">Target Price *</label>
                    <input type="number" id="target" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="stopLoss">Stop Loss *</label>
                    <input type="number" id="stopLoss" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="targetDate">Target Date</label>
                    <input type="date" id="targetDate">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePickModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Pick
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Minimal luxon shim - just enough to prevent Tabulator errors
        if (!window.luxon) {
            window.luxon = {
                DateTime: {
                    isDateTime: function(obj) {
                        return false; // We don't use luxon DateTime objects
                    },
                    fromISO: function(str) {
                        return { isValid: false };
                    },
                    fromMillis: function(ms) {
                        return { isValid: false };
                    },
                    fromSeconds: function(sec) {
                        return { isValid: false };
                    },
                    fromFormat: function(str, fmt) {
                        return { isValid: false };
                    }
                }
            };
        }
    </script>
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const API_BASE = "http://jpmaxtricks.com:8070/api";
        let table;
        let currentPickData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initTable();
            loadPicks();
            setupSliderListeners();

            // Handle form submission
            document.getElementById('pickForm').addEventListener('submit', handleFormSubmit);

            // Fetch stock details when ticker input loses focus (prefill)
            document.getElementById('ticker').addEventListener('blur', async function() {
                const val = this.value && this.value.trim();
                if (!val) return;
                try {
                    const stock = await fetchStock(val);
                    if (stock) {
                        // fill some defaults
                        document.getElementById('entry').value = stock.price != null ? stock.price.toFixed(2) : document.getElementById('entry').value;
                        document.getElementById('stopLoss').value = document.getElementById('stopLoss').value || '';
                        document.getElementById('target').value = document.getElementById('target').value || '';
                    }
                } catch (e) {
                    console.warn('Failed to prefetch stock for', val, e);
                }
            });
        });

        // Custom filter function for numeric comparisons
        function customNumberFilter(headerValue, rowValue, rowData, filterParams) {
            // If no filter value, show all
            if (!headerValue || headerValue.trim() === '') {
                return true;
            }

            const filterStr = headerValue.trim();
            const cellValue = parseFloat(rowValue);

            // If cell value is not a number, don't match
            if (isNaN(cellValue)) {
                return false;
            }

            // Check for comparison operators
            if (filterStr.startsWith('>=')) {
                const threshold = parseFloat(filterStr.substring(2));
                return !isNaN(threshold) && cellValue >= threshold;
            } else if (filterStr.startsWith('<=')) {
                const threshold = parseFloat(filterStr.substring(2));
                return !isNaN(threshold) && cellValue <= threshold;
            } else if (filterStr.startsWith('>')) {
                const threshold = parseFloat(filterStr.substring(1));
                return !isNaN(threshold) && cellValue > threshold;
            } else if (filterStr.startsWith('<')) {
                const threshold = parseFloat(filterStr.substring(1));
                return !isNaN(threshold) && cellValue < threshold;
            } else if (filterStr.startsWith('=')) {
                const threshold = parseFloat(filterStr.substring(1));
                return !isNaN(threshold) && cellValue === threshold;
            } else {
                // Try to parse as a number for exact match
                const threshold = parseFloat(filterStr);
                if (!isNaN(threshold)) {
                    return cellValue === threshold;
                }
                // Otherwise, show all (invalid filter)
                return true;
            }
        }

        function initTable() {
            table = new Tabulator("#picksTable", {
                layout: "fitData",
                height: "calc(100vh - 150px)",
                pagination: true,
                paginationSize: 100,
                paginationSizeSelector: [50, 100, 200, 500],
                selectable: true,
                initialSort: [
                    {column: "addedDate", dir: "desc"} // Sort by added date, newest first
                ],
                columns: [
                    {
                        title: "Tick",
                        field: "ticker",
                        width: 110,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: "Filter...",
                        formatter: function(cell) {
                            const ticker = cell.getValue();
                            const rowData = cell.getRow().getData();
                            const longPatterns = rowData.stock?.noOfLongPatterns || 0;
                            const shortPatterns = rowData.stock?.noOfShortPatterns || 0;

                            let html = `<a href="picks-history.html?ticker=${encodeURIComponent(ticker)}" class="ticker-link">${ticker}</a>`;

                            // Add pattern icons if patterns exist
                            if (longPatterns > 0 || shortPatterns > 0) {
                                html += ' <a href="patterns.html?ticker=' + encodeURIComponent(ticker) + '" target="_blank" style="text-decoration: none;" title="View patterns">';

                                if (longPatterns > 0) {
                                    html += '<span style="display: inline-block; background: #10b981; color: white; font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 700; margin-left: 3px;">L' + longPatterns + '</span>';
                                }

                                if (shortPatterns > 0) {
                                    html += '<span style="display: inline-block; background: #ef4444; color: white; font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 700; margin-left: 2px;">S' + shortPatterns + '</span>';
                                }

                                html += '</a>';
                            }

                            return html;
                        }
                    },
                    {title: "Status",field: "status",width: 75,headerFilter: "input"},
                    {
                        title: "Chg",
                        field: "stock.change",
                        width: 63,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">2",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){
                            const v = cell.getValue();
                            if (v === null || v === undefined || v === '') return '-';
                            const num = parseFloat(v);
                            const formatted = isNaN(num) ? v : num.toFixed(2);
                            if (num > 0) return `<span style="color: #22c55e;">▲ ${formatted}</span>`;
                            if (num < 0) return `<span style="color: #ef4444;">▼ ${formatted}</span>`;
                            return formatted;
                        }
                    },
                    {
                        title: "Added",
                        field: "addedDate",
                        width: 85,
                        editor: "input",
                        sorter: function(a, b, aRow, bRow, column, dir, sorterParams) {
                            // Custom date sorter to ensure proper sorting
                            const aDate = a ? new Date(a) : new Date(0);
                            const bDate = b ? new Date(b) : new Date(0);
                            return aDate - bDate;
                        },
                        headerFilter: "input",
                        headerFilterPlaceholder: "2025-11"
                    },
                    {
                        title: "Monitor",
                        field: "monitor",
                        width: 70,
                        hozAlign: "center",
                        editor: "list",
                        editorParams: {
                            values: ["Y", "N"]
                        },
                        headerFilter: "list",
                        headerFilterParams: {
                            values: ["", "Y", "N"]
                        },
                        formatter: function(cell) {
                            const val = cell.getValue();
                            if (val === "Y") {
                                return '<span style="color: #10b981; font-weight: 700;">Y</span>';
                            } else {
                                return '<span style="color: #94a3b8;">N</span>';
                            }
                        }
                    },
                    {
                        title: "Entry",
                        field: "entry",
                        width: 70,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">100",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const v = cell.getValue();
                            return v ? v.toFixed(2) : '-';
                        }
                    },
                    {
                        title: "Ax",
                        field: "addedPrice",
                        width: 77,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">50",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const v = cell.getValue();
                            return v ? v.toFixed(2) : '-';
                        }
                    },
                     {
                        title: "TGT",
                        field: "target",
                        width: 70,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">150",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const v = cell.getValue();
                            return v ? v.toFixed(2) : '-';
                        }
                    },
                    {
                        title: "Cx",
                        field: "stock.price",
                        width: 70,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">100",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const v = cell.getValue();
                            if (v === null || v === undefined || v === '') return '-';
                            const num = parseFloat(v);
                            return isNaN(num) ? v : num.toFixed(2);
                        }
                    },


                    {
                        title: "Min",
                        field: "min",
                        width: 80,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">50",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const v = cell.getValue();
                            return v ? v.toFixed(2) : '-';
                        }
                    },

                    {
                        title: "Max",
                        field: "max",
                        width: 80,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">50",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const v = cell.getValue();
                            return v ? v.toFixed(2) : '-';
                        }
                    },


                    {
                        title: "Progress",
                        field: "progress",
                        width: 150,
                        sorter: function(a, b, aRow, bRow, column, dir, sorterParams) {
                            // Calculate progress for row a
                            const aData = aRow.getData();
                            const aAddedPrice = parseFloat(aData.addedPrice);
                            const aTarget = parseFloat(aData.target);
                            const aCurrentPrice = parseFloat(aData.stock?.price);
                            const aProgress = (isNaN(aAddedPrice) || isNaN(aTarget) || isNaN(aCurrentPrice) || aAddedPrice === aTarget)
                                ? -999999
                                : ((aCurrentPrice - aAddedPrice) / (aTarget - aAddedPrice)) * 100;

                            // Calculate progress for row b
                            const bData = bRow.getData();
                            const bAddedPrice = parseFloat(bData.addedPrice);
                            const bTarget = parseFloat(bData.target);
                            const bCurrentPrice = parseFloat(bData.stock?.price);
                            const bProgress = (isNaN(bAddedPrice) || isNaN(bTarget) || isNaN(bCurrentPrice) || bAddedPrice === bTarget)
                                ? -999999
                                : ((bCurrentPrice - bAddedPrice) / (bTarget - bAddedPrice)) * 100;

                            return aProgress - bProgress;
                        },
                        headerFilter: "input",
                        headerFilterPlaceholder: ">50",
                        headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                            if (!headerValue || headerValue.trim() === '') {
                                return true;
                            }

                            // Calculate progress for this row
                            const addedPrice = parseFloat(rowData.addedPrice);
                            const target = parseFloat(rowData.target);
                            const currentPrice = parseFloat(rowData.stock?.price);

                            if (isNaN(addedPrice) || isNaN(target) || isNaN(currentPrice) || addedPrice === target) {
                                return false;
                            }

                            const progress = ((currentPrice - addedPrice) / (target - addedPrice)) * 100;

                            // Apply filter comparison
                            const filterStr = headerValue.trim();

                            if (filterStr.startsWith('>=')) {
                                const threshold = parseFloat(filterStr.substring(2));
                                return !isNaN(threshold) && progress >= threshold;
                            } else if (filterStr.startsWith('<=')) {
                                const threshold = parseFloat(filterStr.substring(2));
                                return !isNaN(threshold) && progress <= threshold;
                            } else if (filterStr.startsWith('>')) {
                                const threshold = parseFloat(filterStr.substring(1));
                                return !isNaN(threshold) && progress > threshold;
                            } else if (filterStr.startsWith('<')) {
                                const threshold = parseFloat(filterStr.substring(1));
                                return !isNaN(threshold) && progress < threshold;
                            } else if (filterStr.startsWith('=')) {
                                const threshold = parseFloat(filterStr.substring(1));
                                return !isNaN(threshold) && Math.abs(progress - threshold) < 0.1;
                            } else {
                                const threshold = parseFloat(filterStr);
                                if (!isNaN(threshold)) {
                                    return Math.abs(progress - threshold) < 0.1;
                                }
                                return true;
                            }
                        },
                        formatter: function(cell) {
                            const rowData = cell.getRow().getData();
                            const addedPrice = parseFloat(rowData.addedPrice);
                            const target = parseFloat(rowData.target);
                            const currentPrice = parseFloat(rowData.stock?.price);

                            // Validate we have all required values
                            if (isNaN(addedPrice) || isNaN(target) || isNaN(currentPrice) || addedPrice === target) {
                                return '-';
                            }

                            // Calculate percentage progress from addedPrice to target
                            const progress = ((currentPrice - addedPrice) / (target - addedPrice)) * 100;
                            const percentage = progress.toFixed(1);

                            // Determine color based on progress
                            let barColor;
                            if (progress >= 100) {
                                barColor = '#10b981'; // Green - target reached or exceeded
                            } else if (progress >= 75) {
                                barColor = '#22c55e'; // Light green
                            } else if (progress >= 50) {
                                barColor = '#eab308'; // Yellow
                            } else if (progress >= 25) {
                                barColor = '#f97316'; // Orange
                            } else if (progress >= 0) {
                                barColor = '#fb923c'; // Light orange
                            } else {
                                barColor = '#ef4444'; // Red - below addedPrice
                            }

                            // Clamp progress bar width between 0 and 100
                            const barWidth = Math.min(Math.max(Math.abs(progress), 0), 100);

                            return `
                                <div style="display: flex; align-items: center; width: 100%;">
                                    <div style="flex: 1; background: #1e293b; border-radius: 4px; height: 20px; position: relative; overflow: hidden; border: 1px solid #334155;">
                                        <div style="width: ${barWidth}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 600; color: #f1f5f9; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">
                                            ${percentage}%
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    },
                    {
                        title: "Stop",
                        field: "stopLoss",
                        width: 68,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: "<100",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const v = cell.getValue();
                            return v ? v.toFixed(2) : '-';
                        }
                    },
                    {
                        title: "TgtDt",
                        field: "targetDate",
                        width: 85,
                        editor: "input",
                        sorter: function(a, b, aRow, bRow, column, dir, sorterParams) {
                            const aDate = a ? new Date(a) : new Date(0);
                            const bDate = b ? new Date(b) : new Date(0);
                            return aDate - bDate;
                        },
                        headerFilter: "input",
                        headerFilterPlaceholder: "2025-12"
                    },
                    {
                        title: "DaysLeft",
                        field: "daysLeft",
                        width: 80,
                        headerFilter: "input",
                        headerFilterPlaceholder: "<30",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell, formatterParams, onRendered) {
                            const rowData = cell.getRow().getData();
                            const targetDate = rowData.targetDate;
                            if (!targetDate) {
                                return "-";
                            }
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const target = new Date(targetDate);
                            target.setHours(0, 0, 0, 0);
                            const diffTime = target - today;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            if (diffDays < 0) {
                                return `<span style="color: #ef4444;">${diffDays}</span>`;
                            } else if (diffDays <= 7) {
                                return `<span style="color: #f97316;">${diffDays}</span>`;
                            }
                            return diffDays;
                        },
                        sorter: function(a, b, aRow, bRow, column, dir, sorterParams){
                            const aData = aRow.getData();
                            const bData = bRow.getData();

                            const aTargetDate = aData.targetDate;
                            let aDiffDays = -Infinity;
                            if (aTargetDate) {
                                const aTarget = new Date(aTargetDate);
                                aTarget.setHours(0, 0, 0, 0);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                aDiffDays = Math.ceil((aTarget - today) / (1000 * 60 * 60 * 24));
                            }

                            const bTargetDate = bData.targetDate;
                            let bDiffDays = -Infinity;
                            if (bTargetDate) {
                                const bTarget = new Date(bTargetDate);
                                bTarget.setHours(0, 0, 0, 0);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                bDiffDays = Math.ceil((bTarget - today) / (1000 * 60 * 60 * 24));
                            }

                            return aDiffDays - bDiffDays;
                        }
                    },
                    {
                        title: "T✓",
                        field: "targetMet",
                        width: 57,
                        hozAlign: "center",
                        editor: "tickCross",
                        headerFilter: "tickCross",
                        headerFilterParams: {"tristate": true},
                        headerFilterEmptyCheck: function(value) { return value === null; },
                        formatter: function(cell) {
                            return cell.getValue() ? '<span class="status-met">✓</span>' : '<span class="status-not-met">✗</span>';
                        }
                    },
                    {
                        title: "S✓",
                        field: "stopLossMet",
                        width: 58,
                        hozAlign: "center",
                        editor: "tickCross",
                        headerFilter: "tickCross",
                        headerFilterParams: {"tristate": true},
                        headerFilterEmptyCheck: function(value) { return value === null; },
                        formatter: function(cell) {
                            return cell.getValue() ? '<span class="status-met">✓</span>' : '<span class="status-not-met">✗</span>';
                        }
                    },
                    {
                        title: "TMDt",
                        field: "targetMetDate",
                        width: 85,
                        editor: "input",
                        sorter: function(a, b, aRow, bRow, column, dir, sorterParams) {
                            const aDate = a ? new Date(a) : new Date(0);
                            const bDate = b ? new Date(b) : new Date(0);
                            return aDate - bDate;
                        },
                        headerFilter: "input",
                        headerFilterPlaceholder: "2025-11"
                    },
                    {
                        title: "STDt",
                        field: "stopLossMetDate",
                        width: 85,
                        editor: "input",
                        sorter: function(a, b, aRow, bRow, column, dir, sorterParams) {
                            const aDate = a ? new Date(a) : new Date(0);
                            const bDate = b ? new Date(b) : new Date(0);
                            return aDate - bDate;
                        },
                        headerFilter: "input",
                        headerFilterPlaceholder: "2025-11"
                    },
                    {
                        title: "L#",
                        field: "stock.noOfLongPatterns",
                        width: 60,
                        hozAlign: "center",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">0",
                        headerFilterFunc: customNumberFilter,
                    },
                    {
                        title: "S#",
                        field: "stock.noOfShortPatterns",
                        width: 60,
                        hozAlign: "center",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">0",
                        headerFilterFunc: customNumberFilter,
                    },
                    {
                        title: "Sig",
                        field: "stock.score.signal",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: "BUY"
                    },
                    {
                        title: "PickScore",
                        field: "stock.dailyRank.pickScore",
                        width: 72,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "Rank",
                        field: "stock.dailyRank.finalRank",
                        width: 72,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "Safe",
                        field: "stock.dailyRank.safetyRank",
                        width: 72,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "Bottom",
                        field: "stock.bottom.bottom",
                        width: 70,
                        hozAlign: "center",
                        editor: "tickCross",
                        headerFilter: "tickCross",
                        headerFilterParams: {"tristate": true},
                        headerFilterEmptyCheck: function(value) { return value === null; },
                        formatter: function(cell) {
                            return cell.getValue() ? '<span class="status-met">✓</span>' : '<span class="status-not-met">✗</span>';
                        }
                    },
                    {
                        title: "Spike",
                        field: "stock.spike.spikeLikely",
                        width: 70,
                        hozAlign: "center",
                        editor: "tickCross",
                        headerFilter: "tickCross",
                        headerFilterParams: {"tristate": true},
                        headerFilterEmptyCheck: function(value) { return value === null; },
                        formatter: function(cell) {
                            return cell.getValue() ? '<span class="status-met">✓</span>' : '<span class="status-not-met">✗</span>';
                        }
                    },
                    {
                        title: "SS",
                        field: "stock.spike.spikeScore",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "Score",
                        field: "stock.score.overallScore",
                        width: 72,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "BRS",
                        field: "stock.score.breakoutScore",
                        width: 62,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">60",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "RS",
                        field: "stock.score.reversalScore",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">60",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "PS",
                        field: "stock.score.patternScore",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">60",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "BL",
                        field: "stock.rating.btLongRating",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: "Buy"
                    },
                    {
                        title: "BS",
                        field: "stock.rating.btShortRating",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: "Buy"
                    },
                    {
                        title: "B",
                        field: "stock.rating.btRating",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: "Filter..."
                    },
                    {
                        title: "BT",
                        field: "stock.rating.btTrend",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: "Up"
                    },
                    {
                        title: "TMA",
                        field: "stock.rating.tradingViewMARating",
                        width: 65,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: "Buy"
                    },
                    {
                        title: "TT",
                        field: "stock.rating.tradingViewTechRating",
                        width: 60,
                        editor: "input",
                        headerFilter: "input",
                        headerFilterPlaceholder: "Buy"
                    },
                    {
                        title: "Reason",
                        field: "reason",
                        width: 180,
                        editor: "textarea",
                        headerSort: false,
                        headerFilter: "input",
                        headerFilterPlaceholder: "Filter..."
                    },
                ],
                placeholder: "No picks added yet. Click 'Add Pick' to start.",
            });

            // Cell edited event - auto-save
            table.on("cellEdited", function(cell) {
                const row = cell.getRow();
                const data = row.getData();

                // Auto-save the row (update)
                savePick(data);
            });

            // Update info on data change
            table.on("dataLoaded", updateInfo);
            table.on("dataFiltered", updateInfo);
        }

        async function fetchStock(ticker) {
            if (!ticker) return null;
            try {
                const resp = await fetch(`${API_BASE}/stock/${encodeURIComponent(ticker)}`);
                if (!resp.ok) return null;
                const json = await resp.json();
                return json;
            } catch (e) {
                console.error('Error fetching stock:', e);
                return null;
            }
        }

        /**
         * Get current date in YYYY-MM-DD format using local timezone
         * This avoids the timezone offset issue with toISOString() which returns UTC
         */
        function getLocalDateString() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function loadPicks() {
            try {
                const response = await fetch(`${API_BASE}/picks/list`);
                let data = await response.json();

                console.log('Loaded picks:', data.length);

                // Debug: Check first few addedDate values
                if (data.length > 0) {
                    console.log('Sample addedDate values:', data.slice(0, 5).map(p => ({
                        ticker: p.ticker,
                        addedDate: p.addedDate
                    })));
                }

                // Pre-calculate daysLeft for each pick
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                data.forEach(pick => {
                    if (pick.targetDate) {
                        const target = new Date(pick.targetDate);
                        target.setHours(0, 0, 0, 0);
                        const diffTime = target - today;
                        pick.daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    } else {
                        pick.daysLeft = null;
                    }
                });

                table.setData(data);

                // Explicitly apply sort by addedDate descending (newest first)
                table.setSort([{column: "addedDate", dir: "desc"}]);
                console.log('Sort applied: addedDate desc');

                // Debug: Check if sort was applied
                const sortedData = table.getData();
                if (sortedData.length > 0) {
                    console.log('After sort - first 5 addedDates:', sortedData.slice(0, 5).map(p => ({
                        ticker: p.ticker,
                        addedDate: p.addedDate
                    })));
                }

                updateInfo();
            } catch (error) {
                console.error('Error loading picks:', error);
                alert('Failed to load picks: ' + error.message);
            }
        }

        function updateInfo() {
            const info = document.getElementById('info');
            const total = table.getData().length;
            const filtered = table.getDataCount("active");
            info.textContent = `Total Picks: ${total} | Filtered: ${filtered}`;
        }

        function reloadPicks() {
            loadPicks();
        }

        async function syncPicksWithStock() {
            if (!confirm('Sync all picks with current stock data (prices, changes, pattern counts)?')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';

            try {
                const response = await fetch(`${API_BASE}/picks/sync`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.text();
                    alert('✓ ' + result);
                    await loadPicks(); // Reload to show updated data
                } else {
                    throw new Error('Failed to sync picks');
                }
            } catch (error) {
                console.error('Error syncing picks:', error);
                alert('Failed to sync picks: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function openAddPickModal() {
            document.getElementById('modalTitle').textContent = 'Add New Pick';
            document.getElementById('pickForm').reset();
            document.getElementById('pickId').value = '';

            // Set today's date as default added date
            const today = getLocalDateString();

            document.getElementById('pickModal').style.display = 'block';
        }

        function closePickModal() {
            document.getElementById('pickModal').style.display = 'none';
            currentPickData = null;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const tickerVal = document.getElementById('ticker').value.toUpperCase();
            const pick = {
                id: document.getElementById('pickId').value || null,
                ticker: tickerVal,
                reason: document.getElementById('reason').value,
                entry: parseFloat(document.getElementById('entry').value),
                target: parseFloat(document.getElementById('target').value),
                stopLoss: parseFloat(document.getElementById('stopLoss').value),
                targetDate: document.getElementById('targetDate').value || null,
                addedDate: getLocalDateString(),
                addedPrice: parseFloat(document.getElementById('entry').value), // Default to entry price
                targetMet: false,
                stopLossMet: false,
                monitor: "N" // Default monitor to N
            };

            // Try to enrich pick with current stock details
            try {
                const stock = await fetchStock(tickerVal);
                if (stock) {
                    // merge commonly used fields
                    pick.currentPrice = stock.price;
                    pick.currentChange = stock.change;
                    pick.currentNoOfLongPatterns = stock.noOfLongPatterns;
                    pick.currentNoOfShortPatterns = stock.noOfShortPatterns;
                    pick.noOfLongPatterns = stock.noOfLongPatterns;
                    pick.noOfShortPatterns = stock.noOfShortPatterns;
                    pick.overAllScore = stock.overAllScore || stock.overAllScore || null;
                    pick.bottomScore = stock.bottomScore || null;
                    pick.breakoutScore = stock.breakoutScore || null;
                    pick.patternScore = stock.patternScore || null;
                    pick.spikeScore = stock.spikeScore || null;
                    // barchart/tradingview ratings
                    pick.btShortRating = stock.btShortRating || stock.rating && stock.rating.btShortRating || null;
                    pick.btLongRating = stock.btLongRating || stock.rating && stock.rating.btLongRating || null;
                    pick.btRating = stock.btRating || stock.rating && stock.rating.btRating || null;
                    pick.btTrend = stock.btTrend || stock.rating && stock.rating.btTrend || null;
                    pick.tradingViewTechRating = stock.tradingViewTechRating || stock.rating && stock.rating.tradingViewTechRating || null;
                    pick.tradingViewMARating = stock.tradingViewMARating || stock.rating && stock.rating.tradingViewMARating || null;
                }
            } catch (e) {
                console.warn('Error enriching pick with stock:', e);
            }

            await savePick(pick);
            closePickModal();
        }

        async function savePick(pick) {
            try {
                const url = pick.id ? `${API_BASE}/picks/update` : `${API_BASE}/picks/create`;
                const method = pick.id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pick)
                });

                if (response.ok) {
                    console.log('Pick saved successfully');
                    // reload to get server-assigned id and freshly saved fields
                    await loadPicks();
                } else {
                    const txt = await response.text();
                    throw new Error('Failed to save pick: ' + txt);
                }
            } catch (error) {
                console.error('Error saving pick:', error);
                alert('Failed to save pick: ' + error.message);
            }
        }

        async function deleteSelectedPicks() {
            const selectedRows = table.getSelectedRows();

            if (selectedRows.length === 0) {
                alert('Please select picks to delete');
                return;
            }

            if (!confirm(`Delete ${selectedRows.length} selected pick(s)?`)) {
                return;
            }

            try {
                for (const row of selectedRows) {
                    const data = row.getData();
                    await fetch(`${API_BASE}/picks/delete/${data.id}`, {
                        method: 'DELETE'
                    });
                }

                await loadPicks();
                alert(`Deleted ${selectedRows.length} pick(s)`);
            } catch (error) {
                console.error('Error deleting picks:', error);
                alert('Failed to delete picks: ' + error.message);
            }
        }

        function exportToExcel() {
            table.download("xlsx", "my-picks.xlsx", {sheetName: "Picks"});
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('pickModal');
            if (event.target == modal) {
                closePickModal();
            }
        }

        // Function to add pick from external data (called from stock/pattern pages)
        window.addPickFromData = async function(data) {
            // If data has ticker, try to enrich from stock
            const ticker = (data.ticker || '').toUpperCase();
            document.getElementById('ticker').value = ticker;

            // Try to prefill using stock collection
            const stock = await fetchStock(ticker);
            if (stock) {
                document.getElementById('entry').value = data.entry || stock.price || '';
                document.getElementById('reason').value = data.reason || '';
                document.getElementById('target').value = data.target || data.maxPT || '';
                document.getElementById('stopLoss').value = data.stop || '';
            } else {
                document.getElementById('entry').value = data.entry || '';
                document.getElementById('reason').value = data.reason || '';
                document.getElementById('target').value = data.target || '';
                document.getElementById('stopLoss').value = data.stop || '';
            }

            openAddPickModal();
        };

        // Slider filter functions
        function applySliderFilters() {
            if (!table) {
                console.warn('Table not initialized yet');
                return;
            }

            const filters = [];

            // Progress filter (special handling with custom function)
            const progressThreshold = parseInt(document.getElementById('progressSlider').value);
            console.log('Progress threshold:', progressThreshold);

            // Always add progress filter (even at -100 to ensure it works)
            filters.push(function(data) {
                const addedPrice = parseFloat(data.addedPrice);
                const target = parseFloat(data.target);
                const currentPrice = parseFloat(data.stock?.price);

                // If invalid data, only show if threshold is very low
                if (isNaN(addedPrice) || isNaN(target) || isNaN(currentPrice) || addedPrice === target) {
                    return progressThreshold <= -100;
                }

                const progress = ((currentPrice - addedPrice) / (target - addedPrice)) * 100;
                const result = progress >= progressThreshold;
                return result;
            });

            // PickScore filter
            const pickScore = parseInt(document.getElementById('pickScoreSlider').value);
            if (pickScore > 0) {
                filters.push({ field: 'stock.dailyRank.pickScore', type: '>=', value: pickScore });
            }

            // Rank filter
            const rank = parseInt(document.getElementById('rankSlider').value);
            if (rank > 0) {
                filters.push({ field: 'stock.dailyRank.finalRank', type: '>=', value: rank });
            }

            // Safety filter
            const safe = parseInt(document.getElementById('safeSlider').value);
            if (safe > 0) {
                filters.push({ field: 'stock.dailyRank.safetyRank', type: '>=', value: safe });
            }

            // Spike Score filter
            const spikeScore = parseInt(document.getElementById('spikeScoreSlider').value);
            if (spikeScore > 0) {
                filters.push({ field: 'stock.spike.spikeScore', type: '>=', value: spikeScore });
            }

            // Long Patterns filter
            const longPatterns = parseInt(document.getElementById('longPatternsSlider').value);
            if (longPatterns > 0) {
                filters.push({ field: 'stock.noOfLongPatterns', type: '>=', value: longPatterns });
            }

            // Short Patterns filter
            const shortPatterns = parseInt(document.getElementById('shortPatternsSlider').value);
            if (shortPatterns > 0) {
                filters.push({ field: 'stock.noOfShortPatterns', type: '>=', value: shortPatterns });
            }

            // Days Left filter
            const daysLeftThreshold = parseInt(document.getElementById('daysLeftSlider').value);

            // Only apply the filter if the slider is not at its maximum value
            if (daysLeftThreshold < 60) {
                filters.push(function(data) {
                    // If a pick has no calculated daysLeft, it should not be shown unless the filter is at max
                    if (data.daysLeft === null || data.daysLeft === undefined) {
                        return false;
                    }
                    // Show picks that are expiring within the threshold (from today up to X days)
                    return data.daysLeft >= 0 && data.daysLeft <= daysLeftThreshold;
                });
            }

            console.log('Applying filters:', filters.length);

            if (filters.length > 0) {
                table.setFilter(filters);
            } else {
                table.clearFilter();
            }

            updateInfo();
        }

        function setupSliderListeners() {
            console.log('Setting up slider listeners...');

            // Progress slider
            const progressSlider = document.getElementById('progressSlider');
            const progressValue = document.getElementById('progressValue');
            if (progressSlider && progressValue) {
                console.log('Progress slider found, attaching listener');
                progressSlider.addEventListener('input', function() {
                    const value = this.value;
                    console.log('Progress slider moved to:', value);
                    progressValue.textContent = value + '+';
                    progressValue.style.fontWeight = '700';
                    progressValue.style.fontSize = '12px';
                    console.log('Calling applySliderFilters...');
                    applySliderFilters();
                });
                // Test that slider is interactive
                progressSlider.addEventListener('change', function() {
                    console.log('Progress slider change event fired:', this.value);
                });
            } else {
                console.error('Progress slider elements not found', { progressSlider, progressValue });
            }

            // PickScore slider
            const pickScoreSlider = document.getElementById('pickScoreSlider');
            const pickScoreValue = document.getElementById('pickScoreValue');
            if (pickScoreSlider && pickScoreValue) {
                pickScoreSlider.addEventListener('input', function() {
                    pickScoreValue.textContent = this.value + '+';
                    applySliderFilters();
                });
            }

            // Rank slider
            const rankSlider = document.getElementById('rankSlider');
            const rankValue = document.getElementById('rankValue');
            if (rankSlider && rankValue) {
                rankSlider.addEventListener('input', function() {
                    rankValue.textContent = this.value + '+';
                    applySliderFilters();
                });
            }

            // Safety slider
            const safeSlider = document.getElementById('safeSlider');
            const safeValue = document.getElementById('safeValue');
            if (safeSlider && safeValue) {
                safeSlider.addEventListener('input', function() {
                    safeValue.textContent = this.value + '+';
                    applySliderFilters();
                });
            }

            // Spike Score slider
            const spikeScoreSlider = document.getElementById('spikeScoreSlider');
            const spikeScoreValue = document.getElementById('spikeScoreValue');
            if (spikeScoreSlider && spikeScoreValue) {
                spikeScoreSlider.addEventListener('input', function() {
                    spikeScoreValue.textContent = this.value + '+';
                    applySliderFilters();
                });
            }

            // Long Patterns slider
            const longPatternsSlider = document.getElementById('longPatternsSlider');
            const longPatternsValue = document.getElementById('longPatternsValue');
            if (longPatternsSlider && longPatternsValue) {
                longPatternsSlider.addEventListener('input', function() {
                    longPatternsValue.textContent = this.value + '+';
                    applySliderFilters();
                });
            }

            // Short Patterns slider
            const shortPatternsSlider = document.getElementById('shortPatternsSlider');
            const shortPatternsValue = document.getElementById('shortPatternsValue');
            if (shortPatternsSlider && shortPatternsValue) {
                shortPatternsSlider.addEventListener('input', function() {
                    shortPatternsValue.textContent = this.value + '+';
                    applySliderFilters();
                });
            }

            // Days Left slider
            const daysLeftSlider = document.getElementById('daysLeftSlider');
            const daysLeftValue = document.getElementById('daysLeftValue');
            if (daysLeftSlider && daysLeftValue) {
                daysLeftSlider.addEventListener('input', function() {
                    daysLeftValue.textContent = `< ${this.value}`;
                    applySliderFilters();
                });
            }

            console.log('Slider listeners setup complete');
        }

        function resetSliders() {
            document.getElementById('progressSlider').value = -100;
            document.getElementById('progressValue').textContent = '-100+';
            document.getElementById('pickScoreSlider').value = 0;
            document.getElementById('pickScoreValue').textContent = '0+';
            document.getElementById('rankSlider').value = 0;
            document.getElementById('rankValue').textContent = '0+';
            document.getElementById('safeSlider').value = 0;
            document.getElementById('safeValue').textContent = '0+';
            document.getElementById('spikeScoreSlider').value = 0;
            document.getElementById('spikeScoreValue').textContent = '0+';
            document.getElementById('longPatternsSlider').value = 0;
            document.getElementById('longPatternsValue').textContent = '0+';
            document.getElementById('shortPatternsSlider').value = 0;
            document.getElementById('shortPatternsValue').textContent = '0+';
            document.getElementById('daysLeftSlider').value = 60;
            document.getElementById('daysLeftValue').innerHTML = '&lt; 60';

            if (table) table.clearFilter();
        }

        function clearAllFilters() {
            if (table) table.clearHeaderFilter();
            resetSliders();
        }
    </script>
</body>
</html>

