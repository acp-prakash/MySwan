<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - MySwan</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            font-size: 13px;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: #2d3548;
            border-radius: 8px;
            padding: 20px;
        }
        h1 {
            font-size: 20px;
            color: #ffd700;
            margin-bottom: 5px;
        }
        .nav {
            margin-bottom: 15px;
            font-size: 12px;
        }
        .nav a {
            color: #94a3b8;
            text-decoration: none;
            margin-right: 12px;
        }
        .nav a:hover { color: #ffd700; }
        .section {
            background: #1a1f2e;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            border-left: 3px solid #ffd700;
        }
        .section h3 {
            font-size: 14px;
            color: #ffd700;
            margin-bottom: 8px;
        }
        .row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        label {
            display: block;
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 3px;
        }
        input, textarea {
            width: 100%;
            padding: 6px 8px;
            background: #0f172a;
            border: 1px solid #3f4a5f;
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #ffd700;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        button {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-save {
            background: #ffd700;
            color: #1a1f2e;
        }
        .btn-save:hover {
            background: #ffed4e;
        }
        .btn-clear {
            background: #3f4a5f;
            color: #e2e8f0;
        }
        .btn-clear:hover {
            background: #4a5568;
        }
        .status {
            padding: 8px 10px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
            display: none;
        }
        .status.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }
        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }
        .current {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 6px;
            font-family: 'Courier New', monospace;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            color: #ffd700;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner">‚è≥ Saving...</div>
    </div>

    <div class="container">
        <h1>‚öôÔ∏è Settings</h1>
            <div class="nav">
            <a href="index.html">Dashboard</a>
            <a href="classic.html">Classic</a>
            <a href="futures.html">Futures</a>
            <a href="patterns.html">Patterns</a>
            <a href="discover.html">Discover</a>
        </div>

        <!-- Barchart -->
        <div class="section">
            <h3>üìä Barchart</h3>
            <div class="current" id="barchartCurrent">Token: Loading... | Cookie: Loading...</div>
            <div class="row">
                <div style="flex: 1;">
                    <label>X-XSRF-TOKEN</label>
                    <input type="text" id="barchartToken" placeholder="Token">
                </div>
                <div style="flex: 2;">
                    <label>Cookie</label>
                    <textarea id="barchartCookie" placeholder="Cookie"></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-save" onclick="save('barchart')">Save</button>
                <button class="btn-clear" onclick="clear('barchart')">Clear</button>
                <button class="btn-save" style="background: #10b981;" onclick="autoLoginBarchart()">ü§ñ Auto-Login</button>
            </div>
            <div class="status" id="barchartStatus"></div>
        </div>

        <!-- TradingView -->
        <div class="section">
            <h3>üìà TradingView</h3>
            <div class="current" id="tradingViewCurrent">Token: Loading... | Cookie: Loading...</div>
            <div class="row">
                <div style="flex: 1;">
                    <label>Auth Token (optional)</label>
                    <input type="text" id="tradingViewToken" placeholder="Token">
                </div>
                <div style="flex: 2;">
                    <label>Cookie</label>
                    <textarea id="tradingViewCookie" placeholder="Cookie"></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-save" onclick="save('tradingView')">Save</button>
                <button class="btn-clear" onclick="clear('tradingView')">Clear</button>
                <button class="btn-save" style="background: #10b981;" onclick="autoLoginTradingView()">ü§ñ Auto-Login</button>
            </div>
            <div class="status" id="tradingViewStatus"></div>
        </div>

        <!-- eTrade -->
        <div class="section">
            <h3>üíº eTrade</h3>
            <div class="current" id="etradeCurrent">Token: Loading... | Cookie: Loading...</div>
            <div class="row">
                <div style="flex: 1;">
                    <label>Auth Token</label>
                    <input type="text" id="etradeToken" placeholder="Token">
                </div>
                <div style="flex: 2;">
                    <label>Cookie</label>
                    <textarea id="etradeCookie" placeholder="Cookie"></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-save" onclick="save('etrade')">Save</button>
                <button class="btn-clear" onclick="clear('etrade')">Clear</button>
            </div>
            <div class="status" id="etradeStatus"></div>
        </div>

        <!-- Save All -->
        <div style="text-align: center; margin-top: 15px;">
            <button class="btn-save" style="padding: 8px 30px;" onclick="saveAll()">üíæ Save All</button>
        </div>
    </div>

    <script>
        const API = 'http://jpmaxtricks.com:8070/api';

        // Load current values
        async function loadCurrent() {
            try {
                const res = await fetch(`${API}/cache/get`);
                const data = await res.json();

                // Barchart
                const bcToken = data.barchartToken ? data.barchartToken.substring(0, 15) + '...' : 'Not set';
                const bcCookie = data.barchartCookie ? data.barchartCookie.substring(0, 15) + '...' : 'Not set';
                document.getElementById('barchartCurrent').textContent = `Token: ${bcToken} | Cookie: ${bcCookie}`;

                // TradingView
                const tvToken = data.tradingViewToken ? data.tradingViewToken.substring(0, 15) + '...' : 'Not set';
                const tvCookie = data.tradingViewCookie ? data.tradingViewCookie.substring(0, 15) + '...' : 'Not set';
                document.getElementById('tradingViewCurrent').textContent = `Token: ${tvToken} | Cookie: ${tvCookie}`;

                // eTrade
                const etToken = data.etradeToken ? data.etradeToken.substring(0, 15) + '...' : 'Not set';
                const etCookie = data.etradeCookie ? data.etradeCookie.substring(0, 15) + '...' : 'Not set';
                document.getElementById('etradeCurrent').textContent = `Token: ${etToken} | Cookie: ${etCookie}`;
            } catch (err) {
                console.error('Error loading settings:', err);
            }
        }

        // Save specific provider
        async function save(provider) {
            const payload = {};
            const statusId = provider + 'Status';

            if (provider === 'barchart') {
                const token = document.getElementById('barchartToken').value.trim();
                const cookie = document.getElementById('barchartCookie').value.trim();
                if (!token && !cookie) {
                    showStatus(statusId, 'Enter at least one field', 'error');
                    return;
                }
                if (token) payload.barchartToken = token;
                if (cookie) payload.barchartCookie = cookie;
            } else if (provider === 'tradingView') {
                const token = document.getElementById('tradingViewToken').value.trim();
                const cookie = document.getElementById('tradingViewCookie').value.trim();
                if (!token && !cookie) {
                    showStatus(statusId, 'Enter at least one field', 'error');
                    return;
                }
                if (token) payload.tradingViewToken = token;
                if (cookie) payload.tradingViewCookie = cookie;
            } else if (provider === 'etrade') {
                const token = document.getElementById('etradeToken').value.trim();
                const cookie = document.getElementById('etradeCookie').value.trim();
                if (!token && !cookie) {
                    showStatus(statusId, 'Enter at least one field', 'error');
                    return;
                }
                if (token) payload.etradeToken = token;
                if (cookie) payload.etradeCookie = cookie;
            }

            await sendSave(payload, statusId, provider);
        }

        // Save all
        async function saveAll() {
            const payload = {};

            const bcToken = document.getElementById('barchartToken').value.trim();
            const bcCookie = document.getElementById('barchartCookie').value.trim();
            const tvToken = document.getElementById('tradingViewToken').value.trim();
            const tvCookie = document.getElementById('tradingViewCookie').value.trim();
            const etToken = document.getElementById('etradeToken').value.trim();
            const etCookie = document.getElementById('etradeCookie').value.trim();

            if (bcToken) payload.barchartToken = bcToken;
            if (bcCookie) payload.barchartCookie = bcCookie;
            if (tvToken) payload.tradingViewToken = tvToken;
            if (tvCookie) payload.tradingViewCookie = tvCookie;
            if (etToken) payload.etradeToken = etToken;
            if (etCookie) payload.etradeCookie = etCookie;

            if (Object.keys(payload).length === 0) {
                alert('Enter at least one field');
                return;
            }

            await sendSave(payload, null, 'all');
        }

        // Send save request
        async function sendSave(payload, statusId, provider) {
            document.getElementById('loading').style.display = 'flex';

            try {
                const res = await fetch(`${API}/cache/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                document.getElementById('loading').style.display = 'none';

                if (res.ok) {
                    if (statusId) {
                        showStatus(statusId, 'Saved successfully!', 'success');
                    } else {
                        alert('All settings saved successfully!');
                    }
                    clear(provider);
                    setTimeout(loadCurrent, 500);
                } else {
                    if (statusId) {
                        showStatus(statusId, 'Failed to save', 'error');
                    } else {
                        alert('Failed to save settings');
                    }
                }
            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                if (statusId) {
                    showStatus(statusId, 'Error: ' + err.message, 'error');
                } else {
                    alert('Error: ' + err.message);
                }
            }
        }

        // Clear form
        function clear(provider) {
            if (provider === 'barchart' || provider === 'all') {
                document.getElementById('barchartToken').value = '';
                document.getElementById('barchartCookie').value = '';
            }
            if (provider === 'tradingView' || provider === 'all') {
                document.getElementById('tradingViewToken').value = '';
                document.getElementById('tradingViewCookie').value = '';
            }
            if (provider === 'etrade' || provider === 'all') {
                document.getElementById('etradeToken').value = '';
                document.getElementById('etradeCookie').value = '';
            }
        }

        // Show status message
        function showStatus(id, msg, type) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = `status ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // Auto-login to Barchart
        async function autoLoginBarchart() {
            const statusId = 'barchartStatus';
            const loadingEl = document.getElementById('loading');
            const spinnerEl = loadingEl.querySelector('.spinner');

            // Show loading
            spinnerEl.textContent = 'ü§ñ Auto-Login in progress... This may take 10-20 seconds...';
            loadingEl.style.display = 'flex';

            try {
                const res = await fetch(`${API}/automation/barchart/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();
                loadingEl.style.display = 'none';
                spinnerEl.textContent = '‚è≥ Saving...';

                if (data.status === 'success') {
                    showStatus(statusId, '‚úÖ Auto-login successful! Credentials saved.', 'success');
                    setTimeout(loadCurrent, 500);
                } else if (data.status === 'partial') {
                    showStatus(statusId, '‚ö†Ô∏è Partial success: ' + data.message, 'error');
                    setTimeout(loadCurrent, 500);
                } else {
                    showStatus(statusId, '‚ùå Failed: ' + data.message, 'error');
                }
            } catch (err) {
                loadingEl.style.display = 'none';
                spinnerEl.textContent = '‚è≥ Saving...';
                showStatus(statusId, '‚ùå Error: ' + err.message, 'error');
            }
        }

        // Auto-login to TradingView
        async function autoLoginTradingView() {
            const statusId = 'tradingViewStatus';
            const loadingEl = document.getElementById('loading');
            const spinnerEl = loadingEl.querySelector('.spinner');

            // Show loading
            spinnerEl.textContent = 'ü§ñ TradingView Auto-Login in progress... This may take 15-25 seconds...';
            loadingEl.style.display = 'flex';

            try {
                const res = await fetch(`${API}/automation/tradingview/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();
                loadingEl.style.display = 'none';
                spinnerEl.textContent = '‚è≥ Saving...';

                if (data.status === 'success') {
                    showStatus(statusId, '‚úÖ Auto-login successful! Cookie saved.', 'success');
                    setTimeout(loadCurrent, 500);
                } else {
                    showStatus(statusId, '‚ùå Failed: ' + data.message, 'error');
                }
            } catch (err) {
                loadingEl.style.display = 'none';
                spinnerEl.textContent = '‚è≥ Saving...';
                showStatus(statusId, '‚ùå Error: ' + err.message, 'error');
            }
        }

        // Load on page load
        loadCurrent();
    </script>
</body>
</html>

