<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySwan - Watchlist</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #3b82f6;
            font-size: 1.5rem;
        }

        .toolbar {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .add-section {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-right: auto;
        }

        .add-input {
            padding: 6px 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #f1f5f9;
            font-size: 12px;
            width: 120px;
        }

        .add-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: #f1f5f9;
            border: 1px solid #475569;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.3);
        }

        .info {
            text-align: center;
            margin-top: 5px;
            color: #94a3b8;
            font-size: 11px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 8px;
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            font-size: 12px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Tabulator Dark Theme */
        .tabulator {
            background: #1e293b;
            border: 1px solid #334155;
            font-size: 11px;
        }

        .tabulator .tabulator-header {
            background: #0f172a;
            border-bottom: 2px solid #3b82f6;
        }

        .tabulator .tabulator-header .tabulator-col {
            background: #0f172a;
            color: #f1f5f9;
            border-right: 1px solid #334155;
            padding: 6px 4px;
            font-size: 11px;
        }

        .tabulator .tabulator-tableholder .tabulator-table {
            color: #f1f5f9;
        }

        .tabulator-row {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            min-height: 28px;
            color: #f1f5f9;
        }

        .tabulator-row.tabulator-row-even {
            background: #1a2332;
        }

        .tabulator-row.tabulator-row-odd {
            background: #1e293b;
        }

        .tabulator-row:hover {
            background: #334155 !important;
            color: #f1f5f9 !important;
        }

        .tabulator-row.tabulator-selected {
            background: #1e40af !important;
            color: #f1f5f9 !important;
        }

        .tabulator-cell {
            border-right: 1px solid #334155;
            padding: 4px 6px;
            font-size: 11px;
            color: #f1f5f9;
        }

        .btn-remove {
            padding: 2px 6px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .btn-remove:hover {
            background: #dc2626;
        }

        .signal-buy {
            color: #10b981;
            font-weight: 600;
        }

        .signal-sell {
            color: #ef4444;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        <a href="ticker-groups.html" class="back-link" style="margin-left: 10px;"><i class="fas fa-object-group"></i> Ticker Groups</a>

        <h1><i class="fas fa-eye"></i> My Watchlist</h1>

        <div class="toolbar">
            <div class="add-section">
                <input type="text" id="tickerInput" class="add-input" placeholder="Enter ticker..." maxlength="10">
                <button class="btn btn-primary" onclick="addTicker()">
                    <i class="fas fa-plus"></i> Add to Watchlist
                </button>
            </div>
            <button class="btn btn-success" onclick="reloadWatchlist()">
                <i class="fas fa-sync"></i> Reload
            </button>
            <button class="btn btn-secondary" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
        </div>

        <div id="watchlistTable"></div>
        <div class="info" id="info"></div>
    </div>

    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const API_BASE = "http://jpmaxtricks.com:8070/api";
        let table;

        // Custom filter function for numeric comparisons
        function customNumberFilter(headerValue, rowValue, rowData, filterParams) {
            // If no filter value, show all
            if (!headerValue || headerValue.trim() === '') {
                return true;
            }

            const filterStr = headerValue.trim();
            const cellValue = parseFloat(rowValue);

            // If cell value is not a number, don't match
            if (isNaN(cellValue)) {
                return false;
            }

            // Check for comparison operators
            if (filterStr.startsWith('>=')) {
                const threshold = parseFloat(filterStr.substring(2));
                return !isNaN(threshold) && cellValue >= threshold;
            } else if (filterStr.startsWith('<=')) {
                const threshold = parseFloat(filterStr.substring(2));
                return !isNaN(threshold) && cellValue <= threshold;
            } else if (filterStr.startsWith('>')) {
                const threshold = parseFloat(filterStr.substring(1));
                return !isNaN(threshold) && cellValue > threshold;
            } else if (filterStr.startsWith('<')) {
                const threshold = parseFloat(filterStr.substring(1));
                return !isNaN(threshold) && cellValue < threshold;
            } else if (filterStr.startsWith('=')) {
                const threshold = parseFloat(filterStr.substring(1));
                return !isNaN(threshold) && cellValue === threshold;
            } else {
                // Try to parse as a number for exact match
                const threshold = parseFloat(filterStr);
                if (!isNaN(threshold)) {
                    return cellValue === threshold;
                }
                // Otherwise, show all (invalid filter)
                return true;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initTable();
            loadWatchlist();

            // Enter key in ticker input
            document.getElementById('tickerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTicker();
                }
            });
        });

        function initTable() {
            table = new Tabulator("#watchlistTable", {
                layout: "fitData",
                height: "calc(100vh - 150px)",
                pagination: true,
                paginationSize: 100,
                paginationSizeSelector: [50, 100, 200, 500],
                columns: [
                    {
                        title: "Action",
                        field: "action",
                        width: 30,
                        hozAlign: "center",
                        headerSort: false,
                        formatter: function(cell) {
                            return '<button class="btn-remove" title="Remove from watchlist">X</button>';
                        },
                        cellClick: function(e, cell) {
                            const rowData = cell.getRow().getData();
                            removeFromWatchlist(rowData.ticker);
                        }
                    },
                    {
                        title: "Tick",
                        field: "ticker",
                        width: 110,
                        headerFilter: "input",
                        headerFilterPlaceholder: "Filter...",
                        formatter: function(cell) {
                            const ticker = cell.getValue();
                            const rowData = cell.getRow().getData();
                            const longPatterns = rowData.noOfLongPatterns || 0;
                            const shortPatterns = rowData.noOfShortPatterns || 0;

                            let html = `<a href="stock-history.html?ticker=${encodeURIComponent(ticker)}" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 600;">${ticker}</a>`;

                            // Add pattern icons if patterns exist
                            if (longPatterns > 0 || shortPatterns > 0) {
                                html += ' <a href="patterns.html?ticker=' + encodeURIComponent(ticker) + '" target="_blank" style="text-decoration: none;" title="View patterns">';

                                if (longPatterns > 0) {
                                    html += '<span style="display: inline-block; background: #10b981; color: white; font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 700; margin-left: 3px;">L' + longPatterns + '</span>';
                                }

                                if (shortPatterns > 0) {
                                    html += '<span style="display: inline-block; background: #ef4444; color: white; font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 700; margin-left: 2px;">S' + shortPatterns + '</span>';
                                }

                                html += '</a>';
                            }

                            return html;
                        }
                    },
                    {
                        title: "Opt",
                        field: "optionPref",
                        width: 65,
                        hozAlign: "center",
                        headerFilter: "input"
                    },
                    {
                        title: "Chg",
                        field: "change",
                        width: 70,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">2 or <-1",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){
                            const v = cell.getValue();
                            if (!v) return '-';
                            const formatted = v.toFixed(2);
                            if (v > 0) return `<span style="color: #22c55e;">▲ ${formatted}</span>`;
                            if (v < 0) return `<span style="color: #ef4444;">▼ ${formatted}</span>`;
                            return formatted;
                        }
                    },
                    {
                        title: "Low",
                        field: "low",
                        width: 70,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">50",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(2) : '-'; }
                    },
                    {
                        title: "Price",
                        field: "price",
                        width: 70,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">100",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(2) : '-'; }
                    },
                    {
                        title: "High",
                        field: "high",
                        width: 70,
                        headerFilter: "input",
                        headerFilterPlaceholder: "<200",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(2) : '-'; }
                    },
                    {
                        title: "UpHi",
                        field: "upHigh",
                        width: 70,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">100",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const val = cell.getValue();
                            if (val > 0) return `<span style="color: #22c55e;">${val.toFixed(2)}</span>`;
                            return '-';
                        }
                    },
                    {
                        title: "DnLo",
                        field: "downLow",
                        width: 70,
                        headerFilter: "input",
                        headerFilterPlaceholder: "<100",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const val = cell.getValue();
                            if (val > 0) return `<span style="color: #ef4444;">${val.toFixed(2)}</span>`;
                            return '-';
                        }
                    },
                    {
                        title: "Up↑",
                        field: "upDays",
                        width: 60,
                        hozAlign: "center",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">=3",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const val = cell.getValue();
                            if (val > 0) return `<span style="color: #22c55e; font-weight: 600;">${val}</span>`;
                            return val || '-';
                        }
                    },
                    {
                        title: "Dn↓",
                        field: "downDays",
                        width: 60,
                        hozAlign: "center",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">=3",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell) {
                            const val = cell.getValue();
                            if (val > 0) return `<span style="color: #ef4444; font-weight: 600;">${val}</span>`;
                            return val || '-';
                        }
                    },
                    {
                        title: "L#",
                        field: "noOfLongPatterns",
                        width: 60,
                        hozAlign: "center",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">0",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "S#",
                        field: "noOfShortPatterns",
                        width: 60,
                        hozAlign: "center",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">0",
                        headerFilterFunc: customNumberFilter
                    },
                    {title: "PrimCat", field: "filterCategory.primaryCategory", headerFilter: "input", headerFilterPlaceholder: "<=500", width: 70, sorter:function(a,b){
                // custom sorter: extract leading integer from values like "1-Explosive" or "99-NO-SETUP"
                function leadingNum(v){
                    if(v === null || v === undefined) return Number.MAX_SAFE_INTEGER;
                    var s = String(v).trim();
                    var m = s.match(/^(\d+)/);
                    return m ? parseInt(m[1], 10) : Number.MAX_SAFE_INTEGER;
                }
                var na = leadingNum(a);
                var nb = leadingNum(b);
                if(na !== nb) return na - nb;
                // tie-breaker: compare full string (case-insensitive)
                var sa = (a === null || a === undefined) ? '' : String(a).toLowerCase();
                var sb = (b === null || b === undefined) ? '' : String(b).toLowerCase();
                if(sa < sb) return -1;
                if(sa > sb) return 1;
                return 0;
            }},
            {title: "CatList", field: "filterCategory.category", headerFilter: "input", headerFilterPlaceholder: "<=500", width: 70},


                    {
                        title: "Sig",
                        field: "score.signal",
                        width: 65,
                        headerFilter: "input",
                        headerFilterPlaceholder: "BUY",
                        formatter: function(cell) {
                            const val = cell.getValue();
                            if (val === 'BUY') return '<span class="signal-buy">BUY</span>';
                            if (val === 'SELL') return '<span class="signal-sell">SELL</span>';
                            return val || '-';
                        }
                    },
                    {
                        title: "PickScore",
                        field: "dailyRank.pickScore",
                        width: 72,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "Rank",
                        field: "dailyRank.finalRank",
                        width: 72,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "Safe",
                        field: "dailyRank.safetyRank",
                        width: 72,
                        editor: "number",
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter
                    },
                    {
                        title: "Bottom",
                        field: "bottom.bottom",
                        width: 70,
                        hozAlign: "center",
                        editor: "tickCross",
                        headerFilter: "tickCross",
                        headerFilterParams: {"tristate": true},
                        headerFilterEmptyCheck: function(value) { return value === null; },
                        formatter: function(cell) {
                            return cell.getValue() ? '<span class="status-met">✓</span>' : '<span class="status-not-met">✗</span>';
                        }
                    },
                    {
                        title: "Spike",
                        field: "spike.spikeLikely",
                        width: 70,
                        hozAlign: "center",
                        editor: "tickCross",
                        headerFilter: "tickCross",
                        headerFilterParams: {"tristate": true},
                        headerFilterEmptyCheck: function(value) { return value === null; },
                        formatter: function(cell) {
                            return cell.getValue() ? '<span class="status-met">✓</span>' : '<span class="status-not-met">✗</span>';
                        }
                    },
                    {
                        title: "SS",
                        field: "spike.spikeScore",
                        width: 65,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(0) : '-'; }
                    },
                    {
                        title: "BTM",
                        field: "bottom.conditionsMet",
                        width: 72,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">=5",
                        headerFilterFunc: customNumberFilter
                    },
                    {title: "SigD", field: "score.signalDays", headerFilter: "input", width: 70, formatter: function(cell) { const val = cell.getValue(); if (val === 'BUY') return `<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; if (val === 'SELL') return `<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-size: 9px;">${val}</span>`; return val; }},
                    {
                        title: "All",
                        field: "score.overallScore",
                        width: 70,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">70",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(1) : '-'; }
                    },
                    {
                        title: "BRS",
                        field: "score.breakoutScore",
                        width: 65,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">60",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(1) : '-'; }
                    },
                    {
                        title: "RS",
                        field: "score.reversalScore",
                        width: 65,
                        headerFilter: "input",
                        headerFilterPlaceholder: ">60",
                        headerFilterFunc: customNumberFilter,
                        formatter: function(cell){ const v = cell.getValue(); return v ? v.toFixed(1) : '-'; }
                    },
                    {title: "BL", field: "rating.btShortRating", width: 80, headerFilter: "input", headerFilterPlaceholder: "Buy"},
                    {title: "BS", field: "rating.btLongRating", width: 80, headerFilter: "input", headerFilterPlaceholder: "Buy"},
                    {title: "B", field: "rating.btRating", width: 80, headerFilter: "input", headerFilterPlaceholder: "Filter..."},
                    {title: "BT", field: "rating.btTrend", width: 80, headerFilter: "input", headerFilterPlaceholder: "Up"},
                    {title: "TT", field: "rating.tradingViewTechRating", width: 80, headerFilter: "input", headerFilterPlaceholder: "Buy"},
                    {title: "TMA", field: "rating.tradingViewMARating", width: 80, headerFilter: "input", headerFilterPlaceholder: "Buy"},
                    {title: "OvrSold", field: "oversold.oversoldBounce", headerFilter: "input", headerFilterPlaceholder: "true", width: 70, hozAlign: "center", formatter: function(cell){ const v = cell.getValue(); return (v === true || v === 'true') ? "✅" : ""; }},
                    {title: "OSScore", field: "oversold.bounceScore", headerFilter: "input", headerFilterPlaceholder: ">=5", width: 70, hozAlign: "center"},
                    {title: "OSType", field: "oversold.bounceType", headerFilter: "input", headerFilterPlaceholder: "STRONG", width: 80, hozAlign: "center"},
                ],
                placeholder: "No stocks in watchlist. Add tickers above.",
                initialSort: [
                    {column: "score.overallScore", dir: "desc"}
                ]
            });

            // Update info on data change
            table.on("dataLoaded", updateInfo);
            table.on("dataFiltered", updateInfo);
        }

        async function loadWatchlist() {
            try {
                console.log('Loading watchlist stocks...');
                const response = await fetch(`${API_BASE}/watchlist/stocks`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Loaded watchlist stocks:', data.length);

                table.setData(data);
                updateInfo();
            } catch (error) {
                console.error('Error loading watchlist:', error);
                alert('Failed to load watchlist: ' + error.message);
            }
        }

        function updateInfo() {
            const info = document.getElementById('info');
            const total = table.getData().length;
            const filtered = table.getDataCount("active");
            info.textContent = `Watchlist: ${total} stocks | Filtered: ${filtered}`;
        }

        async function addTicker() {
            const input = document.getElementById('tickerInput');
            const ticker = input.value.trim().toUpperCase();

            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }

            try {
                console.log('Adding ticker to watchlist:', ticker);
                const response = await fetch(`${API_BASE}/watchlist/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ticker: ticker })
                });

                if (response.ok) {
                    console.log('Ticker added successfully');
                    input.value = '';
                    await loadWatchlist();
                    alert(`✓ ${ticker} added to watchlist!`);
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
            } catch (error) {
                console.error('Error adding ticker:', error);
                alert('Failed to add ticker: ' + error.message);
            }
        }

        async function removeFromWatchlist(ticker) {
            if (!confirm(`Remove ${ticker} from watchlist?`)) {
                return;
            }

            try {
                console.log('Removing ticker from watchlist:', ticker);
                const response = await fetch(`${API_BASE}/watchlist/delete/${encodeURIComponent(ticker)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('Ticker removed successfully');
                    await loadWatchlist();
                    alert(`✓ ${ticker} removed from watchlist!`);
                } else {
                    throw new Error('Failed to remove ticker');
                }
            } catch (error) {
                console.error('Error removing ticker:', error);
                alert('Failed to remove ticker: ' + error.message);
            }
        }

        function reloadWatchlist() {
            loadWatchlist();
        }

        function exportToExcel() {
            table.download("xlsx", "my-watchlist.xlsx", {sheetName: "Watchlist"});
        }
    </script>
</body>
</html>

